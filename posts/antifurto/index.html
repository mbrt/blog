<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Antifurto: home made security camera | mbrt blog</title>
<meta name=keywords content="c++,raspberry-pi,code-review"><meta name=description content="Introduction In February 2014 I had a very unpleasant surprise after coming back home from a weekend in Berlin. Me and my girlfriend found out our apartment upside down because of burglars. We suffered the loss not only of many of our belongings, but worse, of our safety. We didn&rsquo;t feel safe in our home and we didn&rsquo;t feel safe to leave it - not even for half an hour - for the fear to come back and find somebody inside."><meta name=author content="Michele Bertasi"><link rel=canonical href=https://blog.mbrt.dev/posts/antifurto/><link crossorigin=anonymous href=/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css integrity="sha256-DE/TclFxNm8zUVWs3m+zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.mbrt.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.mbrt.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.mbrt.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.mbrt.dev/apple-touch-icon.png><link rel=mask-icon href=https://blog.mbrt.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Antifurto: home made security camera"><meta property="og:description" content="Introduction In February 2014 I had a very unpleasant surprise after coming back home from a weekend in Berlin. Me and my girlfriend found out our apartment upside down because of burglars. We suffered the loss not only of many of our belongings, but worse, of our safety. We didn&rsquo;t feel safe in our home and we didn&rsquo;t feel safe to leave it - not even for half an hour - for the fear to come back and find somebody inside."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.mbrt.dev/posts/antifurto/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-07-07T00:00:00+00:00"><meta property="article:modified_time" content="2017-07-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Antifurto: home made security camera"><meta name=twitter:description content="Introduction In February 2014 I had a very unpleasant surprise after coming back home from a weekend in Berlin. Me and my girlfriend found out our apartment upside down because of burglars. We suffered the loss not only of many of our belongings, but worse, of our safety. We didn&rsquo;t feel safe in our home and we didn&rsquo;t feel safe to leave it - not even for half an hour - for the fear to come back and find somebody inside."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.mbrt.dev/posts/"},{"@type":"ListItem","position":2,"name":"Antifurto: home made security camera","item":"https://blog.mbrt.dev/posts/antifurto/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Antifurto: home made security camera","name":"Antifurto: home made security camera","description":"Introduction In February 2014 I had a very unpleasant surprise after coming back home from a weekend in Berlin. Me and my girlfriend found out our apartment upside down because of burglars. We suffered the loss not only of many of our belongings, but worse, of our safety. We didn\u0026rsquo;t feel safe in our home and we didn\u0026rsquo;t feel safe to leave it - not even for half an hour - for the fear to come back and find somebody inside.","keywords":["c++","raspberry-pi","code-review"],"articleBody":"Introduction In February 2014 I had a very unpleasant surprise after coming back home from a weekend in Berlin. Me and my girlfriend found out our apartment upside down because of burglars. We suffered the loss not only of many of our belongings, but worse, of our safety. We didn’t feel safe in our home and we didn’t feel safe to leave it - not even for half an hour - for the fear to come back and find somebody inside. It was with this mood that I started this project: totally motivated to do something about it.\nMy goal was to install in the apartment a security alarm that was cheap, safe and easy to use: something that I could trust. Nowadays there are plenty of alternatives that satisfy all the requirements, but at that moment I couldn’t find anything like that. As I am a software engineer, I decided to jump into the project and spend most of my free time on it (my girlfriend was only partially happy with this resolution).\nThe end result was a Raspberry Pi with a camera module and a bunch of software, in part taken from the open-source and in part written by me. As of the time of writing, it’s been running in production (namely my apartment) untouched for more than two years now. Ironically my security camera lasted way more than my apartment, because since then I already moved twice. So, quite a success for me.\nAnd, if you’re asking yourself if I had any burglars again since then, the answer is no, luckily. But I had the opportunity to test it multiple times when my parents have intruded my apartment without permission…\nWhy? At this point you can probably see my motivation behind the project, and also the target audience: I needed something cheap that I, and my girlfriend could use. This set of users was important for the design. It meant that the normal usage should be simple, because my girlfriend (who is not a developer) had to use it. The configuration and maintenance was however on me, so I didn’t focus on make that simple.\nToday I’m open-sourcing the project. You can find it on GitHub under mbrt/antifurto. The name comes from an Italian word that means “security alarm”. It was a codename at the beginning, waiting to be changed in something better, but in the end I didn’t bother. So antifurto is still the name today.\nWhy am I open-sourcing that now, and not before? Why not keeping it closed source? The project started to meet my needs, so I had no reason at the beginning to open source something that was completely tied to my use case. Nobody would have gotten any particular benefit from it. After some time however it grown up into a more featured product. So, since at the time I wasn’t happy with my job, I considered starting a business and commercialize it. Long story short, getting funds for startups in Italy is quite hard, so I needed money from myself or my family. I then had to improve many parts of the project because I needed to scale out for multiple customers. It was not only about my apartment anymore. In the meantime competitors started to jump out from nowhere before I even got started. I had an opportunity for a new job, so my motivations kinda vaporized.\nAt the end of the day, there is not a commercial product, but a working prototype, and an interesting experience to share. I decided to open-source it now, because I needed time to put together this writeup and cleanup some documentation. All things that I find boring, so it took me a while.\nWhat? In this writeup I’m going to present the interesting bits of the project. I will try to not focus too much on the details, but rather to present clearly the high-level architecture, some design decisions and some interesting implementation bits.\nFeatures The antifurto project is essentially a security camera that allows to monitor what happens through the lenses of a single camera. When the camera detects motion above a certain threshold, it sends notifications through WhatsApp and emails and starts to record pictures. These are in turn saved to the local disk and uploaded to a Dropbox folder. There is also a web portal (optimized for desktop and mobile browsers) from which you can start and stop the monitoring, a live view from which you can see images in real time and an archive page for the past recordings. It’s not possible to combine multiple cameras together: single camera, single website.\nArchitecture The project architecture is simple. Everything lives inside a Raspberry Pi, period. There isn’t a server component communicating with the camera, or anything else. This is not an ideal architecture from the security point of view, because all the keys, including SSL, Dropbox API secrets, email passwords, etc are inside that box. It was the perfect solution for me, because instead of a device and a server to manage, I had only one device. Moreover, the development time was reduced because the architecture was simpler.\nThis unfortunately cannot work out if you want to provide the project to your mother (assuming she’s not a software developer). The Raspberry needs a non-zero amount of maintenance, to provide a minimum amount of security. This includes for example installing OS updates and rebooting the device periodically. The keys need to be safe guarded inside the Raspberry itself, and re-generated in case of leak. Again, this is not good if you want to do it properly, but I preferred to do something quick and get it working as fast as I could.\nNow for the details. The project is divided into three main parts:\nthe main antifurto executable (written in C++), which is responsible for the monitoring and notifications; a web server (Apache + PHP), that serves the website from which you can see the live stream, turn the monitoring on and off and view the archive; a FastCGI component that serves as a bridge between the webserver and the main executable. There are also other small satellite components and scripts, such as:\na bash script to send emails with the mail command; python scripts to send WhatsApp notifications and upload pictures to Dropbox. You can see below a diagram of the high level architecture:\nAs you can see, the pictures come from the camera module and are processed by the antifurto main executable. This decides whether to store the pictures on the local hard drive (an SD card), and upload them on Dropbox or not. It also decides, when to send notifications via email or WhatsApp messages. Whenever the user decides to start a live view from the web interface, or start/stop the monitoring, the backend sends a POSIX signal to the main process. If the desired action was to start the live view, the main executable will start to send the pictures over the zmq channel to the antifurto.fcgi component. Its only task is to forward them to the webserver via an FCGI socket.\nThe design is heavily based on observers, type erasure, composite reuse principle and SOLID principles, to minimize dependencies among components. Well, at least I tried to keep those in mind.\nIn the diagram you can see the architecture of the main executable. Each box represents a class. I didn’t represent all of them, but only the most important. For example I left out the utility classes like schedulers, queues, observer lists. The dark boxes represent controller classes, which are responsible for managing specific parts of the application. Controller classes manage all the boxes connected via a “tilted square” arrow. This means that they both own those classes (so they are responsible for their lifetime) and they know how to operate them. Red boxes don’t manage anything, but they provide a functionality either for other classes or talk to external services.\nOne important thing to notice is that each class is owned by one and only one controller. The architecture and the lifetime of the resources are very simple and clear in this way. A consequence is that classes can be tested individually much more easily, since there are no cyclical dependencies, and children don’t know anything about their parents.\nIn the diagram you can also see what are the inputs and outputs of each class. Red arrows are inputs, and dark arrows are outputs. You can see that I didn’t connect explicitly those arrows. Why? Because they are loose connections. Outputs are provided in the form of observers,1 and classes interested in pictures don’t know anything about the Camera class. So, controllers are responsible to “wire” those connections, by registering themselves to the inputs they need and forward them to the classes they manage. For example the RecordingController class register itself to both alarm notifications (provided by the MotionDetector) and the picture stream (provided by the Camera). It is managed by the MonitorController, so whenever the monitoring functionality is stopped, the recording classes can be safely deleted. The RecordingController then listens to alarm events and whenever one occurs, it forwards the pictures stream directly to the PictureArchive and the DropboxUploader.\nMain executable In this long section I’m going to talk about the internal details of the main executable, called antifurto for a very lack of fantasy.\nMain class The main class is called Antifurto, what a surprise! It is responsible to start and stop the monitoring and the live view, by orchestrating the resources involved. It uses a Config structure for the configuration, that comes from the command line and the configuration file. It can be used as an external library, as most of the components in this project, since it is self contained.\nIt contains all the controllers, that are described in the Main controllers section, and the implementation details are hidden from the header file behind a Pimpl.\nThe interface is very simple: it takes a configuration and the user can control when to start and stop monitoring and live view from four public methods:\nclass Antifurto { public: Antifurto(const Configuration\u0026 c, bool maintenanceNeeded = true); void startMonitoring(); void stopMonitoring(); void startLiveView(); void stopLiveView(); private: meta::ErasedUniquePtr\u003cAntifurtoImpl\u003e pimpl_; }; So, this class is all about the very high level use cases of configuring, starting and stopping the main functionalities.2\nThese functions are a bit less simple than one can at first imagine. For example the startMonitoring is anynchronous and starts the monitoring only after a configurable timeout. This is because after the start, the person may need to get out the way before the monitoring effectively starts. The default I’m using for myself is one minute. At the same time, the function needs to check if the user cancels the start request before the timer goes off. I needed to put some attention in the interaction between start, stop and the destructor. The CameraController lifetime depends on whether one between the monitoring and the live view functionalities are on:\nvoid handleCameraControllerNeed() { if ((liveViewActive_ || monitorActive_) \u0026\u0026 !camera_) camera_.reset(new CameraController()); else if (!liveViewActive_ \u0026\u0026 !monitorActive_) camera_.reset(); } This method is called by all the four external methods, to factor out this common part.\nMain controllers In this section I’m going to describe the three controllers that manage the monitoring, live view and the camera sub-components.\nMonitorController This class controls the monitoring functionality life cycle. It delegates to its sub-components tasks such as motion detection, and notifications. The most important part of its public interface is the examinePicture function:\nvoid examinePicture(const Picture\u0026 picture); The Main class calls this function whenever a new picture comes out of the camera.\nAnother interesting bit is the way this class asks for the upper level controller to change the picture capture interval, or to stop the recording altogether. To break cyclical dependencies, the upper level class has to instantiate the MonitorController by passing a couple of callbacks. One of them is the SetPicturesInterval:\nusing SetPicturesInterval = std::function\u003cvoid(std::chrono::milliseconds)\u003e; that is used whenever some motion is detected. In that case, the MonitorController asks for an increase of the capture frequency. It’s also useful whenever nothing is going on, to decrease the capture frequency and so save energy:\nvoid MonitorController::onAlarmStateChanged(MotionDetector::State state) { using State = MotionDetector::State; switch (state) { case State::NO_ALARM: setPicturesInterval_(config::monitorCycleDuration()); break; case State::PRE_ALARM: setPicturesInterval_(config::monitorCycleDurationOnAlarm()); break; default: break; } log::info() \u003c\u003c \"Alarm state: \" \u003c\u003c state; } CameraController This class is responsible to take pictures from a camera at a given rate. A user of this class can register an observer and specify the rate at which the pictures have to be taken:\nclass CameraController { public: using Subject = meta::Subject\u003cconst Picture\u0026\u003e; using Observer = Subject::Observer; using Registration = Subject::Registration; using Period = std::chrono::milliseconds; /// Set the pictures capture rate void setDesiredPeriod(Registration const\u0026 r, Period period); /// Add an observer to the pictures flow Registration addObserver(Observer observer, Period desiredPeriod); // ... }; This uses the observer pattern, implemented as an utility in the meta namespace.\nEvery time a picture is taken, the observer callback is called. If multiple observers are interested in different capture rates, the maximum rate is used. This means that an observer specifies the minimum speed, but it could get pictures at a higher speed, if it’s necessary for other observers.\nTo implement this functionality, in a separate thread a Metronome class sleeps the required time, and then the Camera class takes a picture. Every time an observer is registered or de-registered, the sleep time is updated.\nLiveViewController This class starts and stops the live view functionality. It doesn’t implement the functionality itself; it just controls the lifetime of a LiveView object. From the outside it takes pictures and the start and stop commands.\nWhenever a picture comes, it is forwarded to the internal LiveView object. To detect when the user is not interested in the live view anymore, there is a primitive control flow, which is basically a fixed queue of pictures sent to the browser. When the client doesn’t request them, the queue fills up. After a certain timeout with a full queue, the LiveViewController simply stops the live view:\nif (liveView_-\u003eaddPicture(p)) lastPictureWrittenTime_ = system_clock::now(); else if (system_clock::now() - lastPictureWrittenTime_ \u003e timeout_) stop(); To do this, the internal LiveView object simply informs whether it has been able to process the image or not, and if not, the timeout is checked.\nThe stop function invokes a callback, that asks to be de-registered from the stream of pictures.\nPicture’s capture MotionDetector This class uses the OpenCV library to examine the pictures flow and determine if something is moving. It implements the observer pattern to notify the observers for the current state. The motion detection code is pretty simple:\ncv::absdiff(curr_, p, currDiff_); cv::bitwise_and(prevDiff_, currDiff_, motion_); if (motionHappened()) onMotionDetected(); else onNoMotion(); // save std::swap(prevDiff_, currDiff_); curr_ = p; The code works with three pictures: the current one and the last two. Two images are computed out of them by making a difference (i.e. subtracting the gray values of the pixels one by one) between the first with the second and the second with the third. Then a “bitwise and” is computed between them. Random noise will be filtered out, since it’s unlikely to stay still for three frames, and the image will be almost completely black. Whenever something moves however, certain areas of the pictures will differ among the three frames, and so the difference will produce white pixels. These pixels are then counted in motionHappened(), and if they exceed a certain threshold, then motion is detected.\nThere is an additional layer of protection against errors, and it’s a state machine that counts how many consecutive moving frames have been detected. These states are used to better control energy saving, picture capture and alarm notifications.\nEvery time a transition occurs in this state machine, all the observers are notified. It will be up to them to take the right action.\nEverything starts from the IDLE state. Whenever some motion is detected, the state becomes PRE_ALARM. If no more motion frames are detected, the state goes back to IDLE. If the motion continues however, the state machine transitions to ALARM. It stays there while the motion continues. When it stops, the state goes to the STILL state. This means that even though nothing is moving, for some time, the alert level is still on alarm. Indeed, if some motion happens again, the state turns immediately to ALARM again. If instead nothing happens for some time, the state goes back to IDLE.\nIn this way we have decoupled the abstract states in which the system may be with the actions the various components have to take to respond.\nCamera The camera type is statically determined in StaticConfig.hpp. In the Raspberry-Pi case, there is a homegrown version implemented by PiCamera that uses a slightly modified version of the picam library, that I found here. This library is a simple interface on top of the Raspberry userland library I forked just to ease the build. To capture images outside the Raspberry world I instead opted for the OpenCV library and implemented CvCamera. Now, I have to admit that the CvCaptureRAII class might look a bit weird, but it was an attempt to implement the camera resource through RAII. I took inspiration from Martinho Fernandez rule of zero blog post and the concern about the rule of zero by Scott Meyers. To discuss this in detail I would need an entire blog post in itself, so I’ll just point you to these valuable resources. To be honest I’m not very satisfied by its look and feel now.\nWith the same spirit I implemented the capture resource for PiCamera, which is just a one liner:\nstd::unique_ptr\u003cCCamera, void(*)(CCamera*)\u003e capture_; It uses the non-so-well-known custom deleter feature of std::unique_ptr. Again, look at the Fernandez’s post for an explanation on why I didn’t just implemented a stupid destructor for PiCamera. Everything is handled automatically, since in the constructor I pass the resource, and the deleter function to be called in destruction (namely picam_stop_camera):\nPiCamera::PiCamera(int width, int height) : width_(width), height_(height) , capture_(::picam_start_camera(width, height, 10, 1, false), \u0026::picam_stop_camera) { // ... } These two different implementations of the camera resource were not intended to be used at the same time: one was only for the Raspberry Pi hardware, and the other for PC’s with USB cameras. For this reason I didn’t introduce any common interface, and just used a compile time define and a typedef to switch between them:\nnamespace antifurto { namespace config { #if defined(ANTIFURTO_RASPBERRY) using Camera = antifurto::PiCamera; #else using Camera = antifurto::CvCamera; #endif }} The code will simply refer to the antifurto::config::Camera type to get a capture resource. I just needed to make sure their public interface (i.e. the public methods) are the same, so the two classes could be used interchangeably.\nThis trick is quite handy if you don’t need runtime polymorphism, but honestly it’s a bit overkill for this project.\nLiveView This class is managed by the LiveViewController and is responsible to forward pictures to a ZeroMQ socket. It has a single producer / single consumer queue (see the concurrency section) and a worker thread to offload the communication.\nThe interesting part about this class is the use of a non-blocking lock-free queue, that allows minimum interruption for the producer. Whenever the queue is full, the images are discarded, and the caller is notified, in order to make some control flow, without interrupting the images flow.\nFor the communication to the webserver we use the request-reply pattern in ZeroMQ. It’s a simple protocol where at very request corresponds one reply. Reconnections are implemented in the FastCGI backend, with the ZmqLazyPirateClient class.\nPicture recording RecordingController This class is responsible for managing the registration of the pictures while an alarm is active. It accepts pictures with the void addPicture(Picture p) method and registers itself to the MotionDetector to know when to start and stop the recording. This is done by saving Jpeg pictures on the local file system (by using PictureArchive) and uploading them to Dropbox (by using DropboxUploader).\nThe state machine is quite simple:\nvoid RecordingController::onAlarmStateChanged(MotionDetector::State state) { using State = MotionDetector::State; switch (state) { case State::NO_MOTION: archive_.stopSaving(); break; case State::NO_ALARM: enqueueOlderPictures(); break; case State::ALARM: archive_.startSaving(); break; case State::PRE_ALARM: default: break; } } Whenever the motion detector notifies this class about an alarm, it starts to save the pictures. When there is no motion involved (even if the alarm is still active), the recording is stopped.\nSaving pictures in real time is important, both on disk and online. If there is a slow upload for any reason, the queue between the producer (the Camera) and the consumer (the uploader), grows. This would mean that by looking at the pictures online, the delay between capture and upload will grow more and more over time during alarms. To avoid this behavior, the queue size is limited, and whenever it’s full, the coming pictures are queued in a secondary one:\nvoid RecordingController::onPictureSaved(const std::string\u0026 fileName) { if (!uploadWorker_.enqueue(fileName)) { log::info() \u003c\u003c \"Failed to upload picture to Dropbox: queue is full\"; std::unique_lock\u003cstd::mutex\u003e lock(toUploadAfterQueueMutex_); toUploadAfterQueue_.emplace(fileName); } } This ensures a fixed maximum delay between capture and upload, just by skipping pictures now and then, when the queue is full. All the missing pictures are instead uploaded when the alarm is not active anymore (the case State::NO_ALARM: above):\nwhile (!toUploadAfterQueue_.empty()) { if (uploadWorker_.enqueue(toUploadAfterQueue_.front())) toUploadAfterQueue_.pop(); else break; } // if the queue is not empty, we need to schedule another upload cycle if (!toUploadAfterQueue_.empty()) { log::info() \u003c\u003c \"Cannot empty the upload queue. Schedule a new upload\"; scheduler_.scheduleAfter(std::chrono::minutes(10), [this] { enqueueOlderPictures(); }); } The logic is a bit brutal but it works. While there is still something to upload, it adds the pictures to the upload queue. If the queue gets full again, a new procedure is scheduled after 10 minutes.\nThere is another maintenance procedure, to avoid a full hard drive. Every 24 hours, older pictures are removed. Depending on the configuration, only a certain amount of days are kept:\n// schedule maintenance at every midnight using namespace std::chrono; auto maintenanceWork = [this] { performMaintenance(); }; scheduler_.scheduleAt(concurrency::tomorrow() + minutes(1), [=] { performMaintenance(); scheduler_.scheduleEvery(hours(24), maintenanceWork); }); PictureArchive This class saves pictures in Jpeg format to a given folder. It takes a stream of pictures and two commands: startSaving and stopSaving. When the recording is started, not only the next picture is saved, but also some of the previous. This object has indeed a fixed sized circular buffer that allows to retroactively save the images right before an alarm popped up. It also allows observers to register for when a picture is saved to disk, getting the file name.\nvoid PictureArchive::save(Picture\u0026 p, Clock t) { std::string filename{ fs::concatPaths(currentFolder_, text::toString(t, text::ToStringFormat::FULL, '-', '_') + \".jpg\")}; cv::putText(p, text::toString(t, text::ToStringFormat::SHORT, '/', ' '), cv::Point(30,30), CV_FONT_HERSHEY_COMPLEX_SMALL, 0.8, cv::Scalar(200,200,250), 1, CV_AA); cv::imwrite(filename, p, {CV_IMWRITE_JPEG_QUALITY, 90}); notifyObservers(filename); } The picture gets a timestamp text overlay on the top left corner and then is saved on disk.\nOn the bad side there is the ring buffer, which is actually not a ring buffer at all. Pictures are pushed to the end of a vector. The beginning is then deleted by moving all the other elements at the previous index. Not pretty, not fast, but all in all it works. Moving to a proper circular buffer should not be very hard.\nDropboxUploader This class is responsible for uploading files to a Dropbox account, by using an external dropbox_uploader.sh script. It just generates a configure file for it, starting from the Antifurto’s configuration, and uploads a file when requested, by launching an external process. Nothing fancy here, I just forked andreafabrizi/Dropbox-Uploader.\nNotifications Two types of notifications are supported: WhatsApp and emails. WhatsApp have been historically fighting against bots. For this reason the phone numbers I used as source for notifications have been banned. I don’t recommend using it for this reason. A much more sane approach would have been to implement a Telegram bot instead, but at that time they didn’t exist. Email notifications are instead much more safe and reliable to use. For those two functionalities we have two very similar controllers: WhatsappNotificationController and MailNotificationController, that register themselves to the MotionDetector and whenever there is an alarm, they try to use their counterpart (WhatsappNotifier and MailNotifier) to send the notifications asynchronously. They also take care of retrials in case of errors, and avoid sending too many of them in a short period of time, to avoid flooding the receivers.\nWhatsappNotifier This class manages WhatsApp notifications. Whenever send(std::string const\u0026 dest, std::string const\u0026 msg) is called, it sends a message with yowsup-cli by spawning an external process. This class just generates the configuration file needed by Yowsup from the main process configuration and takes care of its execution.\nMailNotifier This class is responsible for sending emails.\nvoid send(ContactList const\u0026 dest, std::string const\u0026 sender, std::string const\u0026 subject, std::string const\u0026 body); It calls an external bash script that uses the Unix mail utility, to send the mail.\nUtility libraries Here I present some random notes on the utility namespaces that help with design patterns, concurrency, filesystem and logging. Some of them are a bit over-engineered but in hobby projects you also need to have some fun, don’t you? :)\nmeta namespace This namespace contains some generic patterns and algorithms that do not depend on the specific details of the project itself. In Observer.hpp you can find a generic implementation of the observer pattern. A Subject wants to provide observers the possibility to register for events. The class takes a variadic number of type parameters, that will be used in the notification. For example:\nSubject\u003cint, float\u003e s; auto reg = s.registerObserver([](int a, float b) { print(a, b); }); s.notify(3, 3.14); in this example we want to notify our observer with an integer and a float. To do that we just need to declare Subject with the right parameters. This will in turn be able to accept observers that respect the std::function signature.\nInteresting:\nthe registration returns a token that when goes out of scope unregisters the observer automatically; it is possible to register and unregister observers within notification callbacks (re-entrant calls are supported). Other small utilities are also present, like ErasedUniquePtr, which provides a unique pointer with an erased deleter. This is an useful workaround to a subtle problem when you want to forward declare a class and use it in an unique pointer. For more details see the type erasure post of Andrzej’s blog.\nfs This namespace contains simple path manipulation utilities to concatenate multiple paths with a single call:\nstd::string p = fs::concatPaths(\"/var/log\", bar, \"file.txt\"); This is similar to what boost::filesystem does, but in a more functional way.\nlog This namespace contains logging utilities. The focus of this library was to provide a fast and simple logging without using macro shenanigans.\nYou can use it with a call to a free function, that will return the proper logger:\nlog::debug() \u003c\u003c \"my log here \" \u003c\u003c 15; There is also a reload function. When a log rotation occurs it will simply close the old file (that has been rotated) and open a new file in the same place. Ignored log levels are implemented by returning a logger that writes to a NullSink, which simply does nothing. Interestingly cryptic is the implementation of an std::outstream that does nothing. You can find it in log/NullStream.hpp.\nconcurrency This namespace contains some classes that deal with concurrency. An interesting one is SpScQueue, that wraps a worker thread and allows to enqueue work items for it. The type of the work item is templated, to maximize reusability. The queue is a lock-free implementation that can be chosen at compile time among a fixed-size and a dynamically allocated one. The former is preferred in case the maximum queue size is known at compile time.\nAs a side note I would like to add here that since the project deals with real-time data, avoiding dynamic allocations can be critical. We used fixed bound queues in all places for this reason.\nAnother interesting class in this namespace is the TaskScheduler. It provides the possibility to schedule tasks at certain time points, either one-shot or periodic:\nvoid scheduleAt(Clock::time_point t, Task w); void scheduleAfter(Clock::duration d, Task w); void scheduleEvery(Clock::duration d, Task w); The work items are processed one after the other in a worker thread, so delays added by one task impact on the next ones. It is for this reason used only for short tasks.\nipc This namespace contains classes related to child processes and inter-process communication. There is a forkAndCall function, that forks the process, calls a the given function and returns the function result by using the child process exit code:\n/// This function fork the process, calls the function in the child process, /// wait for completion and returns the function return value. ChildProcess forkAndCall(std::function\u003cint()\u003e f); The child process itself can be killed or waited. In the latter case, the function return code will be returned.\nIn this namespace there is also a NamedPipe class that provides Linux named pipes. The constructor creates a FIFO with the given file name, and the destructor removes it.\nThere is also an interesting PosixSignalHandler class, that handles POSIX signals safely. You need to use it carefully though: initialize it at the beginning of the main function, before any thread creation, and register all the signal handlers as soon as possible, by using:\nvoid setSignalHandler(int signal, Handler h); where an handler is a callback that takes the signal that just happened:\nusing Handler = std::function\u003cvoid(int)\u003e; The POSIX standard says that a lot of functions are not safe to be used within signal handlers. For example it’s not possible to allocate heap memory and call many standard library functions. We need however to support arbitrary code execution in the handlers, so to workaround this we use a vector of atomic booleans, one for each possible signal. Whenever a signal is sent to the process, the handler flips the corresponding boolean to true. A separate thread polls that vector, and executes the registered handlers, if any were given. This allows the signal handler to return immediately and in a safe way:\nstd::vector\u003cstd::atomic\u003cbool\u003e\u003e signalsToBeHandled(SIGRTMAX); void sigactionHandler(int sig, siginfo_t* , void* ) { signalsToBeHandled[sig].store(true, std::memory_order_release); } and the user-defined handler is called asynchronously in a separate thread. This allows to execute arbitrary code.\ntext In this namespace we have some string manipulation utilities, like toString. This free function converts any list of printable objects in an std::string, e.g.\nstd::string s = text::toString(\"my \", std::string(\"s\"), 15, true); Allowing to both covert objects into strings and concatenate them, without the need of odd std::ostringstream objects all around the codebase.\nA TextReplace class allows to do replace variable occurrences in a text with user specified values. For example:\nstd::ifstream f(\"file.txt\"); std::ostringstream out; text::TextReplace r; r.addVariable(\"var\", \"X\"); r.addVariable(\"foo\", \"BAR\"); r.replaceVariables(f, out); and suppose file.txt contains:\nreplace ${var} variables with ${foo} their values ${p}. the result of the replacement will be:\nreplace X variables with BAR their values ${p}. Note that unknown variables are left untouched.\nWebsite I am not so proud of the website code, and I don’t recommend looking at it in detail. I did not have much experience in web development at that time, but I am still quite happy with the result. Year ago it was not so obvious that a website was mobile ready:\nThe website is just a bunch HTML + JavaScript pages. For the styling and the responsive design I went with the immortals Bootstrap and JQuery, while for the server side part I used the now infamous PHP.\nCommands like start and stop monitoring and live view are issued by the frontend by doing GET requests to pages under the controller/ path. The PHP backend listening that endpoint sends POSIX signals to the main executable. The communication is not more complicated than that, because this first implementation worked fine. I didn’t bother changing it in something more complicated.\nThe funniest part of the frontend is the live view though. Also in this case the first implementation was good enough :). Basically the frontend uses an infinite loop of Ajax requests3 to a special live.jpg picture, which is served by a custom FastCGI backend, written in C++. This is the one described in the FastCGI backend section.\nfunction loadImage(url, imageObj, target) { imageObj.onload = function() { target.setAttribute('src', this.src); loadImage(url, imageObj, target); }; imageObj.src = url + '?_=' + new Date().getTime(); } $.ajax({ url: '../controller/live.php', dataType: 'json', cache: false }) .done(function(data) { if (data.result == 0) { $('.live-container').html( '\u003cimg id=\"liveimg\" class=\"img-responsive\"\u003e' ); var img = document.getElementById('liveimg'); loadImage('live.jpg', img, new Image); } else displayMessage('.live-container', '\u003ch4\u003eOoops...\u003c/h4\u003e' + '\u003cp\u003e' + data.log + '\u003c/p\u003e', 'alert-danger'); }) .fail(function(jqxhr, textStatus, errorThrown) { displayMessage('.live-container', '\u003ch4\u003eOoops...\u003c/h4\u003e' + '\u003cp\u003e' + errorThrown + '\u003c/p\u003e', 'alert-danger'); }); Yes, that’s it. I didn’t even have to shorten the code. Something that I couldn’t explain myself here was that in loadImage I couldn’t use JQuery, because it was much slower than the old style setAttribute and image.src = url. So I decided to live with that.\nThe archive page shows pictures from previous alarms. Just don’t look at the PHP code behind that, it’s really horrible crap. It can give you nightmares for days.\nThis is the carusel view:\nThis is the mobile version:\nAnd this is the date selector for the alarm, in the mobile version:\nFastCGI backend One of the website backend components is ironically in a folder called frontend. The name is unfortunate but it was meant to suggest an interface to the main executable. It communicates with it via a ZeroMQ socket, and with the web server through FastCGI.\nInterestingly enough, the first implementation was in Python, but it was too slow. I had to re-implement it in C++, and now it’s about three orders of magnitude faster (yes, I really mean 1000X).\nThe main.cpp file contains all the logic:\nA webserver request is directed to the executable through the standard input (which is ignored); a picture is requested to the main antifurto executable through a ZeroMQ request; as soon as a reply arrives, it is immediately written to the standard output, that is read by the webserver. There are a bunch of utility classes that have been used to make the code cleaner, described in the following sections.\nZmqLazyPirateClient This class implements the Lazy pirate pattern in ZeroMQ, which is a request-reply transition supporting socket reconnections. This allows to start and stop the main executable and the webserver independently; the connection between them will catch up automatically. When a request-reply transaction is needed, this class will send the request and wait until the reply comes, or a timeout expires. On timeout, the request is sent again, until the maximum number of retrials is reached. At that point the transaction is considered failed.\nStream utilities The StreamRedirector class is responsible for redirecting the standard input and output to FastCGI stream buffers, while StreamReader allows to buffer reads from a stream (in this case the standard input). I actually don’t remember because it’s a class instead of a simple function. Probably it’s a non-sense.\nConclusion In this post we had a look at the pet project I worked on for a while some years ago. By skimming through this post again I realized that it is mostly a random collection of impressions, design decisions and code snippets, so I don’t know how effective that is for a reader. However, for me it was important to wrap up, because after all the time and effort spent, I didn’t want to forget it, and I also wanted to share my insights with the community.4\nMy takeaways are that with this project I learned some stuff and I did something useful for myself. I would definitely recommend working on things you really need, as opposed to experimenting with technologies purposelessly. It really helps to get them done (to a certain extent at least). Or at least that’s the only way I found preventing me to give up projects too early.5\nI hope this post gave you some interesting insights and maybe inspire you some extensions, related projects or ideas. The code is open source on GitHub, under mbrt/antifurto, as I wrote earlier. I encourage you to take a look yourself to some of the classes. You can also build it and use it as is for your own security alarm. The deployment is kind of a pain right now, because there are many dependencies and configuring the external services is not exactly easy to do (Dropbox, mails, WhatsApp, etc). The documentation is also somehow lacking; apologies for that.\nThat’s all folks!\nTake a look at the meta namespace for the implementation. ↩︎\nIf you are curious, the ErasedUniquePtr class is briefly described in the meta namespace section. ↩︎\nYes, I know WebSocket existed already years ago, but really, at that time my phone didn’t support them, and I didn’t feel like developing two different protocols. ↩︎\nThe license is GPL. ↩︎\nSee do finish your stuff by Martin Sústrik. ↩︎\n","wordCount":"6164","inLanguage":"en","datePublished":"2017-07-07T00:00:00Z","dateModified":"2017-07-07T00:00:00Z","author":{"@type":"Person","name":"Michele Bertasi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mbrt.dev/posts/antifurto/"},"publisher":{"@type":"Organization","name":"mbrt blog","logo":{"@type":"ImageObject","url":"https://blog.mbrt.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.mbrt.dev/ accesskey=h title="mbrt blog (Alt + H)">mbrt blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.mbrt.dev/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://blog.mbrt.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.mbrt.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.mbrt.dev/>Home</a>&nbsp;»&nbsp;<a href=https://blog.mbrt.dev/posts/>Posts</a></div><h1 class=post-title>Antifurto: home made security camera</h1><div class=post-meta><span title='2017-07-07 00:00:00 +0000 UTC'>July 7, 2017</span>&nbsp;·&nbsp;29 min&nbsp;·&nbsp;Michele Bertasi</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a><ul><li><a href=#why aria-label=Why?>Why?</a></li><li><a href=#what aria-label=What?>What?</a></li><li><a href=#features aria-label=Features>Features</a></li></ul></li><li><a href=#architecture aria-label=Architecture>Architecture</a></li><li><a href=#main-executable aria-label="Main executable">Main executable</a><ul><li><a href=#main-class aria-label="Main class">Main class</a></li><li><a href=#main-controllers aria-label="Main controllers">Main controllers</a><ul><li><a href=#monitorcontroller aria-label=MonitorController>MonitorController</a></li><li><a href=#cameracontroller aria-label=CameraController>CameraController</a></li><li><a href=#liveviewcontroller aria-label=LiveViewController>LiveViewController</a></li></ul></li><li><a href=#pictures-capture aria-label="Picture&amp;rsquo;s capture">Picture&rsquo;s capture</a><ul><li><a href=#motiondetector aria-label=MotionDetector>MotionDetector</a></li><li><a href=#camera aria-label=Camera>Camera</a></li></ul></li><li><a href=#liveview aria-label=LiveView>LiveView</a></li><li><a href=#picture-recording aria-label="Picture recording">Picture recording</a><ul><li><a href=#recordingcontroller aria-label=RecordingController>RecordingController</a></li><li><a href=#picturearchive aria-label=PictureArchive>PictureArchive</a></li><li><a href=#dropboxuploader aria-label=DropboxUploader>DropboxUploader</a></li></ul></li><li><a href=#notifications aria-label=Notifications>Notifications</a><ul><li><a href=#whatsappnotifier aria-label=WhatsappNotifier>WhatsappNotifier</a></li><li><a href=#mailnotifier aria-label=MailNotifier>MailNotifier</a></li></ul></li><li><a href=#utility-libraries aria-label="Utility libraries">Utility libraries</a><ul><li><a href=#meta-namespace aria-label="meta namespace">meta namespace</a></li><li><a href=#fs aria-label=fs>fs</a></li><li><a href=#log aria-label=log>log</a></li><li><a href=#concurrency aria-label=concurrency>concurrency</a></li><li><a href=#ipc aria-label=ipc>ipc</a></li><li><a href=#text aria-label=text>text</a></li></ul></li></ul></li><li><a href=#website aria-label=Website>Website</a></li><li><a href=#fastcgi-backend aria-label="FastCGI backend">FastCGI backend</a><ul><li><a href=#zmqlazypirateclient aria-label=ZmqLazyPirateClient>ZmqLazyPirateClient</a></li><li><a href=#stream-utilities aria-label="Stream utilities">Stream utilities</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><h1 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h1><p>In February 2014 I had a very unpleasant surprise after coming back home from a
weekend in Berlin. Me and my girlfriend found out our apartment upside down
because of burglars. We suffered the loss not only of many of our belongings,
but worse, of our safety. We didn&rsquo;t feel safe in our home and we didn&rsquo;t feel
safe to leave it - not even for half an hour - for the fear to come back and
find somebody inside. It was with this mood that I started this project: totally
motivated to do something about it.</p><p>My goal was to install in the apartment a security alarm that was cheap, safe
and easy to use: something that I could trust. Nowadays there are plenty of
alternatives that satisfy all the requirements, but at that moment I couldn&rsquo;t
find anything like that. As I am a software engineer, I decided to jump into the
project and spend most of my free time on it (my girlfriend was only partially
happy with this resolution).</p><p>The end result was a Raspberry Pi with a camera module and a bunch of software,
in part taken from the open-source and in part written by me. As of the time of
writing, it&rsquo;s been running in production (namely my apartment) untouched for
more than two years now. Ironically my security camera lasted way more than my
apartment, because since then I already moved twice. So, quite a success for me.</p><p>And, if you&rsquo;re asking yourself if I had any burglars again since then, the
answer is no, luckily. But I had the opportunity to test it multiple times when
my parents have intruded my apartment without permission&mldr;</p><p><img loading=lazy src=camera.jpg alt=img></p><h2 id=why>Why?<a hidden class=anchor aria-hidden=true href=#why>#</a></h2><p>At this point you can probably see my motivation behind the project, and also
the target audience: I needed something cheap that I, and my girlfriend could
use. This set of users was important for the design. It meant that the normal
usage should be simple, because my girlfriend (who is not a developer) had to
use it. The configuration and maintenance was however on me, so I didn&rsquo;t focus
on make that simple.</p><p>Today I&rsquo;m open-sourcing the project. You can find it on GitHub under
<a href=https://github.com/mbrt/antifurto>mbrt/antifurto</a>. The name comes from an
Italian word that means &ldquo;security alarm&rdquo;. It was a codename at the beginning,
waiting to be changed in something better, but in the end I didn&rsquo;t bother. So
antifurto is still the name today.</p><p>Why am I open-sourcing that now, and not before? Why not keeping it closed
source? The project started to meet my needs, so I had no reason at the
beginning to open source something that was completely tied to my use case.
Nobody would have gotten any particular benefit from it. After some time however
it grown up into a more featured product. So, since at the time I wasn&rsquo;t happy
with my job, I considered starting a business and commercialize it. Long story
short, getting funds for startups in Italy is quite hard, so I needed money from
myself or my family. I then had to improve many parts of the project because I
needed to scale out for multiple customers. It was not only about my apartment
anymore. In the meantime competitors started to jump out from nowhere before I
even got started. I had an opportunity for a new job, so my motivations kinda
vaporized.</p><p>At the end of the day, there is not a commercial product, but a working
prototype, and an interesting experience to share. I decided to open-source it
now, because I needed time to put together this writeup and cleanup some
documentation. All things that I find boring, so it took me a while.</p><h2 id=what>What?<a hidden class=anchor aria-hidden=true href=#what>#</a></h2><p>In this writeup I&rsquo;m going to present the interesting bits of the project. I will
try to not focus too much on the details, but rather to present clearly the
high-level architecture, some design decisions and some interesting
implementation bits.</p><h2 id=features>Features<a hidden class=anchor aria-hidden=true href=#features>#</a></h2><p>The antifurto project is essentially a security camera that allows to monitor
what happens through the lenses of a single camera. When the camera detects
motion above a certain threshold, it sends notifications through WhatsApp and
emails and starts to record pictures. These are in turn saved to the local disk
and uploaded to a Dropbox folder. There is also a web portal (optimized for
desktop and mobile browsers) from which you can start and stop the monitoring, a
live view from which you can see images in real time and an archive page for the
past recordings. It&rsquo;s not possible to combine multiple cameras together: single
camera, single website.</p><h1 id=architecture>Architecture<a hidden class=anchor aria-hidden=true href=#architecture>#</a></h1><p>The project architecture is simple. Everything lives inside a Raspberry Pi,
period. There isn&rsquo;t a server component communicating with the camera, or
anything else. This is not an ideal architecture from the security point of
view, because all the keys, including SSL, Dropbox API secrets, email passwords,
etc are inside that box. It was the perfect solution for me, because instead of
a device and a server to manage, I had only one device. Moreover, the
development time was reduced because the architecture was simpler.</p><p>This unfortunately cannot work out if you want to provide the project to your
mother (assuming she&rsquo;s not a software developer). The Raspberry needs a non-zero
amount of maintenance, to provide a minimum amount of security. This includes
for example installing OS updates and rebooting the device periodically. The
keys need to be safe guarded inside the Raspberry itself, and re-generated in
case of leak. Again, this is not good if you want to do it properly, but I
preferred to do something quick and get it working as fast as I could.</p><p>Now for the details. The project is divided into three main parts:</p><ul><li>the main <code>antifurto</code> executable (written in C++), which is responsible for the
monitoring and notifications;</li><li>a web server (Apache + PHP), that serves the website from which you can see
the live stream, turn the monitoring on and off and view the archive;</li><li>a FastCGI component that serves as a bridge between the webserver and the main
executable.</li></ul><p>There are also other small satellite components and scripts, such as:</p><ul><li>a bash script to send emails with the <code>mail</code> command;</li><li>python scripts to send WhatsApp notifications and upload pictures to Dropbox.</li></ul><p>You can see below a diagram of the high level architecture:</p><p><img loading=lazy src=overview.svg alt=img></p><p>As you can see, the pictures come from the camera module and are processed by
the <code>antifurto</code> main executable. This decides whether to store the pictures on
the local hard drive (an SD card), and upload them on Dropbox or not. It also
decides, when to send notifications via email or WhatsApp messages. Whenever the
user decides to start a live view from the web interface, or start/stop the
monitoring, the backend sends a POSIX signal to the main process. If the desired
action was to start the live view, the main executable will start to send the
pictures over the <code>zmq</code> channel to the <code>antifurto.fcgi</code> component. Its only task
is to forward them to the webserver via an FCGI socket.</p><p>The design is heavily based on
<a href=https://en.wikipedia.org/wiki/Observer_pattern>observers</a>,
<a href=https://en.wikipedia.org/wiki/Type_erasure>type erasure</a>,
<a href=https://en.wikipedia.org/wiki/Composition_over_inheritance>composite reuse principle</a> and
<a href=https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)>SOLID principles</a>, to
minimize dependencies among components. Well, at least I tried to keep those in
mind.</p><p><img loading=lazy src=hierarchy.svg alt=img></p><p>In the diagram you can see the architecture of the main executable. Each box
represents a class. I didn&rsquo;t represent all of them, but only the most important.
For example I left out the utility classes like schedulers, queues, observer
lists. The dark boxes represent controller classes, which are responsible for
managing specific parts of the application. Controller classes manage all the
boxes connected via a &ldquo;tilted square&rdquo; arrow. This means that they both own those
classes (so they are responsible for their lifetime) and they know how to
operate them. Red boxes don&rsquo;t manage anything, but they provide a functionality
either for other classes or talk to external services.</p><p>One important thing to notice is that each class is owned by one and only one
controller. The architecture and the lifetime of the resources are very simple
and clear in this way. A consequence is that classes can be tested individually
much more easily, since there are no cyclical dependencies, and children don&rsquo;t
know anything about their parents.</p><p>In the diagram you can also see what are the inputs and outputs of each class.
Red arrows are inputs, and dark arrows are outputs. You can see that I didn&rsquo;t
connect explicitly those arrows. Why? Because they are loose connections.
Outputs are provided in the form of observers,<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>
and classes interested in pictures don&rsquo;t know anything
about the <a href=#camera>Camera</a> class. So, controllers are responsible to &ldquo;wire&rdquo;
those connections, by registering themselves to the inputs they need and forward
them to the classes they manage. For example the <a href=#recordingcontroller>RecordingController</a> class
register itself to both alarm notifications (provided by the
<a href=#motiondetector>MotionDetector</a>) and the picture stream (provided by the
<a href=#camera>Camera</a>). It is managed by the <a href=#motioncontroller>MonitorController</a>, so whenever
the monitoring functionality is stopped, the recording classes can be safely
deleted. The <code>RecordingController</code> then listens to alarm events and whenever one
occurs, it forwards the pictures stream directly to the <a href=#picturearchive>PictureArchive</a> and
the <a href=#dropboxuploader>DropboxUploader</a>.</p><h1 id=main-executable>Main executable<a hidden class=anchor aria-hidden=true href=#main-executable>#</a></h1><p>In this long section I&rsquo;m going to talk about the internal details of the main
executable, called <code>antifurto</code> for a very lack of fantasy.</p><h2 id=main-class>Main class<a hidden class=anchor aria-hidden=true href=#main-class>#</a></h2><p>The main class is called <code>Antifurto</code>, what a surprise! It is responsible to
start and stop the monitoring and the live view, by orchestrating the resources
involved. It uses a <code>Config</code> structure for the configuration, that comes from
the command line and the configuration file. It can be used as an external
library, as most of the components in this project, since it is self contained.</p><p>It contains all the controllers, that are described in the <a href=#main-controllers>Main controllers</a>
section, and the implementation details are hidden from the header file behind a
<a href=https://herbsutter.com/gotw/_100/>Pimpl</a>.</p><p>The interface is very simple: it takes a configuration and the user can control
when to start and stop monitoring and live view from four public methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Antifurto</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    Antifurto(<span style=color:#ff79c6>const</span> Configuration<span style=color:#ff79c6>&amp;</span> c, <span style=color:#8be9fd>bool</span> maintenanceNeeded <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>startMonitoring</span>();
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>stopMonitoring</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>startLiveView</span>();
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>stopLiveView</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>private</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    meta<span style=color:#ff79c6>::</span>ErasedUniquePtr<span style=color:#ff79c6>&lt;</span>AntifurtoImpl<span style=color:#ff79c6>&gt;</span> pimpl_;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>So, this class is all about the very high level use cases of configuring,
starting and stopping the main functionalities.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p>These functions are a bit less simple than one can at first imagine. For example
the <code>startMonitoring</code> is anynchronous and starts the monitoring only after a
configurable timeout. This is because after the start, the person may need to
get out the way before the monitoring effectively starts. The default I&rsquo;m using
for myself is one minute. At the same time, the function needs to check if the
user cancels the start request before the timer goes off. I needed to put some
attention in the interaction between start, stop and the destructor. The
<a href=#cameracontroller>CameraController</a> lifetime depends on whether one between the monitoring and the
live view functionalities are on:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>handleCameraControllerNeed</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> ((liveViewActive_ <span style=color:#ff79c6>||</span> monitorActive_) <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>camera_)
</span></span><span style=display:flex><span>    camera_.reset(<span style=color:#ff79c6>new</span> CameraController());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>liveViewActive_ <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>monitorActive_)
</span></span><span style=display:flex><span>    camera_.reset();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This method is called by all the four external methods, to factor out this
common part.</p><h2 id=main-controllers>Main controllers<a hidden class=anchor aria-hidden=true href=#main-controllers>#</a></h2><p>In this section I&rsquo;m going to describe the three controllers that manage the
monitoring, live view and the camera sub-components.</p><h3 id=monitorcontroller>MonitorController<a hidden class=anchor aria-hidden=true href=#monitorcontroller>#</a></h3><p>This class controls the monitoring functionality life cycle. It delegates to its
sub-components tasks such as motion detection, and notifications. The most
important part of its public interface is the <code>examinePicture</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>examinePicture</span>(<span style=color:#ff79c6>const</span> Picture<span style=color:#ff79c6>&amp;</span> picture);
</span></span></code></pre></div><p>The <a href=#main-class>Main class</a> calls this function whenever a new picture comes out of the
camera.</p><p>Another interesting bit is the way this class asks for the upper level
controller to change the picture capture interval, or to stop the recording
altogether. To break cyclical dependencies, the upper level class has to
instantiate the <code>MonitorController</code> by passing a couple of callbacks. One of
them is the <code>SetPicturesInterval</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>using</span> SetPicturesInterval <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>function<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>void</span>(std<span style=color:#ff79c6>::</span>chrono<span style=color:#ff79c6>::</span>milliseconds)<span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>that is used whenever some motion is detected. In that case, the
<code>MonitorController</code> asks for an increase of the capture frequency. It&rsquo;s also
useful whenever nothing is going on, to decrease the capture frequency and so
save energy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> MonitorController<span style=color:#ff79c6>::</span>onAlarmStateChanged(MotionDetector<span style=color:#ff79c6>::</span>State state)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>using</span> State <span style=color:#ff79c6>=</span> MotionDetector<span style=color:#ff79c6>::</span>State;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>switch</span> (state) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> State<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>NO_ALARM</span>:
</span></span><span style=display:flex><span>        setPicturesInterval_(config<span style=color:#ff79c6>::</span>monitorCycleDuration());
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> State<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>PRE_ALARM</span>:
</span></span><span style=display:flex><span>        setPicturesInterval_(config<span style=color:#ff79c6>::</span>monitorCycleDurationOnAlarm());
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    log<span style=color:#ff79c6>::</span>info() <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Alarm state: &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> state;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=cameracontroller>CameraController<a hidden class=anchor aria-hidden=true href=#cameracontroller>#</a></h3><p>This class is responsible to take pictures from a camera at a given rate. A user
of this class can register an observer and specify the rate at which the
pictures have to be taken:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>CameraController</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>using</span> Subject <span style=color:#ff79c6>=</span> meta<span style=color:#ff79c6>::</span>Subject<span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>const</span> Picture<span style=color:#ff79c6>&amp;&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>using</span> Observer <span style=color:#ff79c6>=</span> Subject<span style=color:#ff79c6>::</span>Observer;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>using</span> Registration <span style=color:#ff79c6>=</span> Subject<span style=color:#ff79c6>::</span>Registration;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>using</span> Period <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>chrono<span style=color:#ff79c6>::</span>milliseconds;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/// Set the pictures capture rate
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setDesiredPeriod</span>(Registration <span style=color:#ff79c6>const</span><span style=color:#ff79c6>&amp;</span> r, Period period);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>/// Add an observer to the pictures flow
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    Registration <span style=color:#50fa7b>addObserver</span>(Observer observer, Period desiredPeriod);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>};
</span></span></code></pre></div><p>This uses the observer pattern, implemented as an utility in the
<a href=#meta-namespace>meta namespace</a>.</p><p>Every time a picture is taken, the observer callback is called. If multiple
observers are interested in different capture rates, the maximum rate is used.
This means that an observer specifies the minimum speed, but it could get
pictures at a higher speed, if it&rsquo;s necessary for other observers.</p><p>To implement this functionality, in a separate thread a <code>Metronome</code> class sleeps
the required time, and then the <code>Camera</code> class takes a picture. Every time an
observer is registered or de-registered, the sleep time is updated.</p><h3 id=liveviewcontroller>LiveViewController<a hidden class=anchor aria-hidden=true href=#liveviewcontroller>#</a></h3><p>This class starts and stops the live view functionality. It doesn&rsquo;t implement
the functionality itself; it just controls the lifetime of a <a href=#liveview>LiveView</a>
object. From the outside it takes pictures and the start and stop commands.</p><p>Whenever a picture comes, it is forwarded to the internal <code>LiveView</code> object. To
detect when the user is not interested in the live view anymore, there is a
primitive control flow, which is basically a fixed queue of pictures sent to the
browser. When the client doesn&rsquo;t request them, the queue fills up. After a
certain timeout with a full queue, the <code>LiveViewController</code> simply stops the
live view:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>if</span> (liveView_<span style=color:#ff79c6>-&gt;</span>addPicture(p))
</span></span><span style=display:flex><span>    lastPictureWrittenTime_ <span style=color:#ff79c6>=</span> system_clock<span style=color:#ff79c6>::</span>now();
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span> <span style=color:#50fa7b>if</span> (system_clock<span style=color:#ff79c6>::</span>now() <span style=color:#ff79c6>-</span> lastPictureWrittenTime_ <span style=color:#ff79c6>&gt;</span> timeout_)
</span></span><span style=display:flex><span>    stop();
</span></span></code></pre></div><p>To do this, the internal <code>LiveView</code> object simply informs whether it has been
able to process the image or not, and if not, the timeout is checked.</p><p>The <code>stop</code> function invokes a callback, that asks to be de-registered from the
stream of pictures.</p><h2 id=pictures-capture>Picture&rsquo;s capture<a hidden class=anchor aria-hidden=true href=#pictures-capture>#</a></h2><h3 id=motiondetector>MotionDetector<a hidden class=anchor aria-hidden=true href=#motiondetector>#</a></h3><p>This class uses the <a href=http://opencv.org/>OpenCV</a> library to examine the pictures
flow and determine if something is moving. It implements the observer pattern to
notify the observers for the current state. The motion detection code is pretty
simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>cv<span style=color:#ff79c6>::</span>absdiff(curr_, p, currDiff_);
</span></span><span style=display:flex><span>cv<span style=color:#ff79c6>::</span>bitwise_and(prevDiff_, currDiff_, motion_);
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (motionHappened())
</span></span><span style=display:flex><span>    onMotionDetected();
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>onNoMotion</span>();
</span></span><span style=display:flex><span><span style=color:#6272a4>// save
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>std<span style=color:#ff79c6>::</span>swap(prevDiff_, currDiff_);
</span></span><span style=display:flex><span>    curr_ <span style=color:#ff79c6>=</span> p;
</span></span></code></pre></div><p>The code works with three pictures: the current one and the last two. Two images
are computed out of them by making a difference (i.e. subtracting the gray
values of the pixels one by one) between the first with the second and the
second with the third. Then a &ldquo;bitwise and&rdquo; is computed between them. Random
noise will be filtered out, since it&rsquo;s unlikely to stay still for three frames,
and the image will be almost completely black. Whenever something moves however,
certain areas of the pictures will differ among the three frames, and so the
difference will produce white pixels. These pixels are then counted in
<code>motionHappened()</code>, and if they exceed a certain threshold, then motion is
detected.</p><p>There is an additional layer of protection against errors, and it&rsquo;s a state
machine that counts how many consecutive moving frames have been detected. These
states are used to better control energy saving, picture capture and alarm
notifications.</p><p><img loading=lazy src=motion-detector.svg alt=img></p><p>Every time a transition occurs in this state machine, all the observers are
notified. It will be up to them to take the right action.</p><p>Everything starts from the <code>IDLE</code> state. Whenever some motion is detected, the
state becomes <code>PRE_ALARM</code>. If no more motion frames are detected, the state goes
back to <code>IDLE</code>. If the motion continues however, the state machine transitions
to <code>ALARM</code>. It stays there while the motion continues. When it stops, the state
goes to the <code>STILL</code> state. This means that even though nothing is moving, for
some time, the alert level is still on alarm. Indeed, if some motion happens
again, the state turns immediately to <code>ALARM</code> again. If instead nothing happens
for some time, the state goes back to <code>IDLE</code>.</p><p>In this way we have decoupled the abstract states in which the system may be
with the actions the various components have to take to respond.</p><h3 id=camera>Camera<a hidden class=anchor aria-hidden=true href=#camera>#</a></h3><p>The camera type is statically determined in <code>StaticConfig.hpp</code>. In the
Raspberry-Pi case, there is a homegrown version implemented by <code>PiCamera</code> that
uses a slightly modified version of the <code>picam</code> library, that I found
<a href=http://robotblogging.blogspot.nl/2013/10/an-efficient-and-simple-c-api-for.html>here</a>.
This library is a simple interface on top of the Raspberry
<a href=https://github.com/mbrt/userland>userland</a> library I forked just to ease the
build. To capture images outside the Raspberry world I instead opted for the
<a href=http://opencv.org/>OpenCV</a> library and implemented <code>CvCamera</code>. Now, I have to
admit that the <code>CvCaptureRAII</code> class might look a bit weird, but it was an
attempt to implement the camera resource through
<a href=https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization>RAII</a>. I
took inspiration from Martinho Fernandez <a href=https://rmf.io/cxx11/rule-of-zero>rule of
zero</a> blog post and the <a href=http://scottmeyers.blogspot.nl/2014/03/a-concern-about-rule-of-zero.html>concern about the
rule of
zero</a>
by Scott Meyers. To discuss this in detail I would need an entire blog post in
itself, so I&rsquo;ll just point you to these valuable resources. To be honest I&rsquo;m not
very satisfied by its look and feel now.</p><p>With the same spirit I implemented the capture resource for <code>PiCamera</code>, which is
just a one liner:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>std<span style=color:#ff79c6>::</span>unique_ptr<span style=color:#ff79c6>&lt;</span>CCamera, <span style=color:#8be9fd>void</span>(<span style=color:#ff79c6>*</span>)(CCamera<span style=color:#ff79c6>*</span>)<span style=color:#ff79c6>&gt;</span> capture_;
</span></span></code></pre></div><p>It uses the non-so-well-known custom deleter feature of <code>std::unique_ptr</code>.
Again, look at the Fernandez&rsquo;s post for an explanation on why I didn&rsquo;t just
implemented a stupid destructor for <code>PiCamera</code>. Everything is handled
automatically, since in the constructor I pass the resource, and the deleter
function to be called in destruction (namely <code>picam_stop_camera</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>PiCamera<span style=color:#ff79c6>::</span>PiCamera(<span style=color:#8be9fd>int</span> width, <span style=color:#8be9fd>int</span> height)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>:</span> width_(width), height_(height)
</span></span><span style=display:flex><span>    , capture_(<span style=color:#ff79c6>::</span>picam_start_camera(width, height, <span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>1</span>, <span style=color:#8be9fd;font-style:italic>false</span>),
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&amp;::</span>picam_stop_camera)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span></code></pre></div><p>These two different implementations of the camera resource were not intended to
be used at the same time: one was only for the Raspberry Pi hardware, and the
other for PC&rsquo;s with USB cameras. For this reason I didn&rsquo;t introduce any common
interface, and just used a compile time define and a <code>typedef</code> to switch between
them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>namespace</span> antifurto {
</span></span><span style=display:flex><span><span style=color:#ff79c6>namespace</span> config {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#if defined(ANTIFURTO_RASPBERRY)
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>using</span> Camera <span style=color:#ff79c6>=</span> antifurto<span style=color:#ff79c6>::</span>PiCamera;
</span></span><span style=display:flex><span><span style=color:#ff79c6>#else
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>    <span style=color:#ff79c6>using</span> Camera <span style=color:#ff79c6>=</span> antifurto<span style=color:#ff79c6>::</span>CvCamera;
</span></span><span style=display:flex><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>}}
</span></span></code></pre></div><p>The code will simply refer to the <code>antifurto::config::Camera</code> type to get a
capture resource. I just needed to make sure their public interface (i.e. the
public methods) are the same, so the two classes could be used interchangeably.</p><p>This trick is quite handy if you don&rsquo;t need runtime polymorphism, but honestly
it&rsquo;s a bit overkill for this project.</p><h2 id=liveview>LiveView<a hidden class=anchor aria-hidden=true href=#liveview>#</a></h2><p>This class is managed by the <a href=#liveviewcontroller>LiveViewController</a> and is responsible to forward
pictures to a <a href=http://zeromq.org/>ZeroMQ</a> socket. It has a single producer /
single consumer queue (see the <a href=#concurrency>concurrency</a> section) and a worker thread
to offload the communication.</p><p>The interesting part about this class is the use of a non-blocking lock-free
queue, that allows minimum interruption for the producer. Whenever the queue is
full, the images are discarded, and the caller is notified, in order to make
some control flow, without interrupting the images flow.</p><p>For the communication to the webserver we use the <a href=http://zguide.zeromq.org/page:all#Ask-and-Ye-Shall-Receive>request-reply
pattern</a> in ZeroMQ.
It&rsquo;s a simple protocol where at very request corresponds one reply.
Reconnections are implemented in the <a href=#fastcgi-backend>FastCGI backend</a>, with the
<a href=#zmqlazypirateclient>ZmqLazyPirateClient</a> class.</p><h2 id=picture-recording>Picture recording<a hidden class=anchor aria-hidden=true href=#picture-recording>#</a></h2><h3 id=recordingcontroller>RecordingController<a hidden class=anchor aria-hidden=true href=#recordingcontroller>#</a></h3><p>This class is responsible for managing the registration of the pictures while an
alarm is active. It accepts pictures with the <code>void addPicture(Picture p)</code>
method and registers itself to the <a href=#motiondetector>MotionDetector</a> to know when to start
and stop the recording. This is done by saving Jpeg pictures on the local file
system (by using <a href=#picturearchive>PictureArchive</a>) and uploading them to Dropbox (by using
<a href=#dropboxuploader>DropboxUploader</a>).</p><p>The state machine is quite simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> RecordingController<span style=color:#ff79c6>::</span>onAlarmStateChanged(MotionDetector<span style=color:#ff79c6>::</span>State state)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>using</span> State <span style=color:#ff79c6>=</span> MotionDetector<span style=color:#ff79c6>::</span>State;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>switch</span> (state) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> State<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>NO_MOTION</span>:
</span></span><span style=display:flex><span>        archive_.stopSaving();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> State<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>NO_ALARM</span>:
</span></span><span style=display:flex><span>        enqueueOlderPictures();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> State<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>ALARM</span>:
</span></span><span style=display:flex><span>        archive_.startSaving();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> State<span style=color:#ff79c6>::</span><span style=color:#8be9fd;font-style:italic>PRE_ALARM</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Whenever the motion detector notifies this class about an alarm, it starts to
save the pictures. When there is no motion involved (even if the alarm is still
active), the recording is stopped.</p><p>Saving pictures in real time is important, both on disk and online. If there is
a slow upload for any reason, the queue between the producer (the
<a href=#camera>Camera</a>) and the consumer (the uploader), grows. This would mean
that by looking at the pictures online, the delay between capture and upload
will grow more and more over time during alarms. To avoid this behavior, the
queue size is limited, and whenever it&rsquo;s full, the coming pictures are queued in
a secondary one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> RecordingController<span style=color:#ff79c6>::</span>onPictureSaved(<span style=color:#ff79c6>const</span> std<span style=color:#ff79c6>::</span>string<span style=color:#ff79c6>&amp;</span> fileName)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>uploadWorker_.enqueue(fileName)) {
</span></span><span style=display:flex><span>        log<span style=color:#ff79c6>::</span>info() <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Failed to upload picture to Dropbox: queue is full&#34;</span>;
</span></span><span style=display:flex><span>        std<span style=color:#ff79c6>::</span>unique_lock<span style=color:#ff79c6>&lt;</span>std<span style=color:#ff79c6>::</span>mutex<span style=color:#ff79c6>&gt;</span> lock(toUploadAfterQueueMutex_);
</span></span><span style=display:flex><span>        toUploadAfterQueue_.emplace(fileName);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This ensures a fixed maximum delay between capture and upload, just by skipping
pictures now and then, when the queue is full. All the missing pictures are
instead uploaded when the alarm is not active anymore (the <code>case State::NO_ALARM:</code> above):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>!</span>toUploadAfterQueue_.empty()) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (uploadWorker_.enqueue(toUploadAfterQueue_.front()))
</span></span><span style=display:flex><span>        toUploadAfterQueue_.pop();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#6272a4>// if the queue is not empty, we need to schedule another upload cycle
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>toUploadAfterQueue_.empty()) {
</span></span><span style=display:flex><span>    log<span style=color:#ff79c6>::</span>info() <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Cannot empty the upload queue. Schedule a new upload&#34;</span>;
</span></span><span style=display:flex><span>    scheduler_.scheduleAfter(std<span style=color:#ff79c6>::</span>chrono<span style=color:#ff79c6>::</span>minutes(<span style=color:#bd93f9>10</span>), [<span style=color:#ff79c6>this</span>] {
</span></span><span style=display:flex><span>            enqueueOlderPictures();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The logic is a bit brutal but it works. While there is still something to
upload, it adds the pictures to the upload queue. If the queue gets full again,
a new procedure is scheduled after 10 minutes.</p><p>There is another maintenance procedure, to avoid a full hard drive. Every 24
hours, older pictures are removed. Depending on the configuration, only a
certain amount of days are kept:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#6272a4>// schedule maintenance at every midnight
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>using</span> <span style=color:#ff79c6>namespace</span> std<span style=color:#ff79c6>::</span>chrono;
</span></span><span style=display:flex><span><span style=color:#ff79c6>auto</span> maintenanceWork <span style=color:#ff79c6>=</span> [<span style=color:#ff79c6>this</span>] { performMaintenance(); };
</span></span><span style=display:flex><span>scheduler_.scheduleAt(concurrency<span style=color:#ff79c6>::</span>tomorrow() <span style=color:#ff79c6>+</span> minutes(<span style=color:#bd93f9>1</span>), [<span style=color:#ff79c6>=</span>] {
</span></span><span style=display:flex><span>    performMaintenance();
</span></span><span style=display:flex><span>    scheduler_.scheduleEvery(hours(<span style=color:#bd93f9>24</span>), maintenanceWork);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=picturearchive>PictureArchive<a hidden class=anchor aria-hidden=true href=#picturearchive>#</a></h3><p>This class saves pictures in Jpeg format to a given folder. It takes a stream of
pictures and two commands: <code>startSaving</code> and <code>stopSaving</code>. When the recording is
started, not only the next picture is saved, but also some of the previous. This
object has indeed a fixed sized circular buffer that allows to retroactively
save the images right before an alarm popped up. It also allows observers to
register for when a picture is saved to disk, getting the file name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> PictureArchive<span style=color:#ff79c6>::</span>save(Picture<span style=color:#ff79c6>&amp;</span> p, Clock t)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>string filename{ fs<span style=color:#ff79c6>::</span>concatPaths(currentFolder_,
</span></span><span style=display:flex><span>        text<span style=color:#ff79c6>::</span>toString(t, text<span style=color:#ff79c6>::</span>ToStringFormat<span style=color:#ff79c6>::</span>FULL, <span style=color:#f1fa8c>&#39;-&#39;</span>, <span style=color:#f1fa8c>&#39;_&#39;</span>) <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.jpg&#34;</span>)};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cv<span style=color:#ff79c6>::</span>putText(p, text<span style=color:#ff79c6>::</span>toString(t, text<span style=color:#ff79c6>::</span>ToStringFormat<span style=color:#ff79c6>::</span>SHORT, <span style=color:#f1fa8c>&#39;/&#39;</span>, <span style=color:#f1fa8c>&#39; &#39;</span>),
</span></span><span style=display:flex><span>                cv<span style=color:#ff79c6>::</span>Point(<span style=color:#bd93f9>30</span>,<span style=color:#bd93f9>30</span>), CV_FONT_HERSHEY_COMPLEX_SMALL, <span style=color:#bd93f9>0.8</span>,
</span></span><span style=display:flex><span>                cv<span style=color:#ff79c6>::</span>Scalar(<span style=color:#bd93f9>200</span>,<span style=color:#bd93f9>200</span>,<span style=color:#bd93f9>250</span>), <span style=color:#bd93f9>1</span>, CV_AA);
</span></span><span style=display:flex><span>    cv<span style=color:#ff79c6>::</span>imwrite(filename, p, {CV_IMWRITE_JPEG_QUALITY, <span style=color:#bd93f9>90</span>});
</span></span><span style=display:flex><span>    notifyObservers(filename);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The picture gets a timestamp text overlay on the top left corner and then is
saved on disk.</p><p>On the bad side there is the ring buffer, which is actually not a ring buffer at
all. Pictures are pushed to the end of a vector. The beginning is then deleted
by moving all the other elements at the previous index. Not pretty, not fast,
but all in all it works. Moving to a proper circular buffer should not be very
hard.</p><h3 id=dropboxuploader>DropboxUploader<a hidden class=anchor aria-hidden=true href=#dropboxuploader>#</a></h3><p>This class is responsible for uploading files to a Dropbox account, by using an
external <code>dropbox_uploader.sh</code> script. It just generates a configure file for
it, starting from the Antifurto&rsquo;s configuration, and uploads a file when
requested, by launching an external process. Nothing fancy here, I just forked
<a href=https://github.com/andreafabrizi/Dropbox-Uploader>andreafabrizi/Dropbox-Uploader</a>.</p><h2 id=notifications>Notifications<a hidden class=anchor aria-hidden=true href=#notifications>#</a></h2><p>Two types of notifications are supported: WhatsApp and emails. WhatsApp have
been historically fighting against bots. For this reason the phone numbers I
used as source for notifications have been banned. I don&rsquo;t recommend using it
for this reason. A much more sane approach would have been to implement a
Telegram bot instead, but at that time they didn&rsquo;t exist. Email notifications
are instead much more safe and reliable to use. For those two functionalities we
have two very similar controllers: <code>WhatsappNotificationController</code> and
<code>MailNotificationController</code>, that register themselves to the
<a href=#motiondetector>MotionDetector</a> and whenever there is an alarm, they try to use their
counterpart (<a href=#whatsappnotifier>WhatsappNotifier</a> and <a href=#mailnotifier>MailNotifier</a>) to send the
notifications asynchronously. They also take care of retrials in case of errors,
and avoid sending too many of them in a short period of time, to avoid flooding
the receivers.</p><h3 id=whatsappnotifier>WhatsappNotifier<a hidden class=anchor aria-hidden=true href=#whatsappnotifier>#</a></h3><p>This class manages WhatsApp notifications. Whenever <code>send(std::string const& dest, std::string const& msg)</code> is called, it sends a message with
<a href=https://github.com/mbrt/yowsup>yowsup-cli</a> by spawning an external process.
This class just generates the configuration file needed by Yowsup from the main
process configuration and takes care of its execution.</p><h3 id=mailnotifier>MailNotifier<a hidden class=anchor aria-hidden=true href=#mailnotifier>#</a></h3><p>This class is responsible for sending emails.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>send</span>(ContactList <span style=color:#ff79c6>const</span><span style=color:#ff79c6>&amp;</span> dest,
</span></span><span style=display:flex><span>            std<span style=color:#ff79c6>::</span>string <span style=color:#ff79c6>const</span><span style=color:#ff79c6>&amp;</span> sender,
</span></span><span style=display:flex><span>            std<span style=color:#ff79c6>::</span>string <span style=color:#ff79c6>const</span><span style=color:#ff79c6>&amp;</span> subject,
</span></span><span style=display:flex><span>            std<span style=color:#ff79c6>::</span>string <span style=color:#ff79c6>const</span><span style=color:#ff79c6>&amp;</span> body);
</span></span></code></pre></div><p>It calls an external bash script that uses the Unix <code>mail</code> utility, to send the
mail.</p><h2 id=utility-libraries>Utility libraries<a hidden class=anchor aria-hidden=true href=#utility-libraries>#</a></h2><p>Here I present some random notes on the utility namespaces that help with design
patterns, concurrency, filesystem and logging. Some of them are a bit
over-engineered but in hobby projects you also need to have some fun, don&rsquo;t you?
:)</p><h3 id=meta-namespace>meta namespace<a hidden class=anchor aria-hidden=true href=#meta-namespace>#</a></h3><p>This namespace contains some generic patterns and algorithms that do not depend
on the specific details of the project itself. In <code>Observer.hpp</code> you can find a
generic implementation of the <a href=https://en.wikipedia.org/wiki/Observer_pattern>observer
pattern</a>. A <code>Subject</code> wants to
provide observers the possibility to register for events. The class takes a
variadic number of type parameters, that will be used in the notification. For
example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Subject<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>int</span>, <span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> s;
</span></span><span style=display:flex><span><span style=color:#ff79c6>auto</span> reg <span style=color:#ff79c6>=</span> s.registerObserver([](<span style=color:#8be9fd>int</span> a, <span style=color:#8be9fd>float</span> b) { print(a, b); });
</span></span><span style=display:flex><span>s.notify(<span style=color:#bd93f9>3</span>, <span style=color:#bd93f9>3.14</span>);
</span></span></code></pre></div><p>in this example we want to notify our observer with an integer and a float. To
do that we just need to declare <code>Subject</code> with the right parameters. This will
in turn be able to accept observers that respect the <code>std::function&lt;void(int, float)></code> signature.</p><p>Interesting:</p><ul><li>the registration returns a token that when goes out of scope unregisters the
observer automatically;</li><li>it is possible to register and unregister observers within notification
callbacks (re-entrant calls are supported).</li></ul><p>Other small utilities are also present, like <code>ErasedUniquePtr</code>, which provides a
unique pointer with an erased deleter. This is an useful workaround to a subtle
problem when you want to forward declare a class and use it in an unique
pointer. For more details see the <a href=https://akrzemi1.wordpress.com/2013/12/11/type-erasure-part-iii/>type erasure
post</a> of
Andrzej&rsquo;s blog.</p><h3 id=fs>fs<a hidden class=anchor aria-hidden=true href=#fs>#</a></h3><p>This namespace contains simple path manipulation utilities to concatenate
multiple paths with a single call:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>std<span style=color:#ff79c6>::</span>string p <span style=color:#ff79c6>=</span> fs<span style=color:#ff79c6>::</span>concatPaths(<span style=color:#f1fa8c>&#34;/var/log&#34;</span>, bar, <span style=color:#f1fa8c>&#34;file.txt&#34;</span>);
</span></span></code></pre></div><p>This is similar to what <code>boost::filesystem</code> does, but in a more functional way.</p><h3 id=log>log<a hidden class=anchor aria-hidden=true href=#log>#</a></h3><p>This namespace contains logging utilities. The focus of this library was to
provide a fast and simple logging without using macro shenanigans.</p><p>You can use it with a call to a free function, that will return the proper
logger:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>log<span style=color:#ff79c6>::</span>debug() <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;my log here &#34;</span> <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#bd93f9>15</span>;
</span></span></code></pre></div><p>There is also a <code>reload</code> function. When a log rotation occurs it will simply
close the old file (that has been rotated) and open a new file in the same
place. Ignored log levels are implemented by returning a logger that writes to a
<code>NullSink</code>, which simply does nothing. Interestingly cryptic is the
implementation of an <code>std::outstream</code> that does nothing. You can find it in
<code>log/NullStream.hpp</code>.</p><h3 id=concurrency>concurrency<a hidden class=anchor aria-hidden=true href=#concurrency>#</a></h3><p>This namespace contains some classes that deal with concurrency. An interesting
one is <code>SpScQueue</code>, that wraps a worker thread and allows to enqueue work items
for it. The type of the work item is templated, to maximize reusability. The
queue is a lock-free implementation that can be chosen at compile time among a
fixed-size and a dynamically allocated one. The former is preferred in case the
maximum queue size is known at compile time.</p><p>As a side note I would like to add here that since the project deals with
real-time data, avoiding dynamic allocations can be critical. We used fixed
bound queues in all places for this reason.</p><p>Another interesting class in this namespace is the <code>TaskScheduler</code>. It provides
the possibility to schedule tasks at certain time points, either one-shot or
periodic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>scheduleAt</span>(Clock<span style=color:#ff79c6>::</span>time_point t, Task w);
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>scheduleAfter</span>(Clock<span style=color:#ff79c6>::</span>duration d, Task w);
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>scheduleEvery</span>(Clock<span style=color:#ff79c6>::</span>duration d, Task w);
</span></span></code></pre></div><p>The work items are processed one after the other in a worker thread, so delays
added by one task impact on the next ones. It is for this reason used only for
short tasks.</p><h3 id=ipc>ipc<a hidden class=anchor aria-hidden=true href=#ipc>#</a></h3><p>This namespace contains classes related to child processes and inter-process
communication. There is a <code>forkAndCall</code> function, that forks the process, calls
a the given function and returns the function result by using the child process
exit code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#6272a4>/// This function fork the process, calls the function in the child process,
</span></span></span><span style=display:flex><span><span style=color:#6272a4>/// wait for completion and returns the function return value.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>ChildProcess <span style=color:#50fa7b>forkAndCall</span>(std<span style=color:#ff79c6>::</span>function<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>int</span>()<span style=color:#ff79c6>&gt;</span> f);
</span></span></code></pre></div><p>The child process itself can be killed or waited. In the latter case, the
function return code will be returned.</p><p>In this namespace there is also a <code>NamedPipe</code> class that provides Linux named
pipes. The constructor creates a <a href=https://linux.die.net/man/3/mkfifo>FIFO</a> with
the given file name, and the destructor removes it.</p><p>There is also an interesting <code>PosixSignalHandler</code> class, that handles POSIX
signals safely. You need to use it carefully though: initialize it at the
beginning of the main function, before any thread creation, and register all the
signal handlers as soon as possible, by using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setSignalHandler</span>(<span style=color:#8be9fd>int</span> signal, Handler h);
</span></span></code></pre></div><p>where an handler is a callback that takes the signal that just happened:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff79c6>using</span> Handler <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>function<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>void</span>(<span style=color:#8be9fd>int</span>)<span style=color:#ff79c6>&gt;</span>;
</span></span></code></pre></div><p>The POSIX standard says that a lot of functions are not safe to be used within
signal handlers. For example it&rsquo;s not possible to allocate heap memory and call
many standard library functions. We need however to support arbitrary code
execution in the handlers, so to workaround this we use a vector of atomic
booleans, one for each possible signal. Whenever a signal is sent to the
process, the handler flips the corresponding boolean to true. A separate thread
polls that vector, and executes the registered handlers, if any were given. This
allows the signal handler to return immediately and in a safe way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>std<span style=color:#ff79c6>::</span>vector<span style=color:#ff79c6>&lt;</span>std<span style=color:#ff79c6>::</span>atomic<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>bool</span><span style=color:#ff79c6>&gt;&gt;</span> signalsToBeHandled(SIGRTMAX);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sigactionHandler</span>(<span style=color:#8be9fd>int</span> sig, siginfo_t<span style=color:#ff79c6>*</span> , <span style=color:#8be9fd>void</span><span style=color:#ff79c6>*</span> )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    signalsToBeHandled[sig].store(<span style=color:#8be9fd;font-style:italic>true</span>, std<span style=color:#ff79c6>::</span>memory_order_release);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>and the user-defined handler is called asynchronously in a separate thread. This
allows to execute arbitrary code.</p><h3 id=text>text<a hidden class=anchor aria-hidden=true href=#text>#</a></h3><p>In this namespace we have some string manipulation utilities, like <code>toString</code>.
This free function converts any list of printable objects in an <code>std::string</code>,
e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>std<span style=color:#ff79c6>::</span>string s <span style=color:#ff79c6>=</span> text<span style=color:#ff79c6>::</span>toString(<span style=color:#f1fa8c>&#34;my &#34;</span>, std<span style=color:#ff79c6>::</span>string(<span style=color:#f1fa8c>&#34;s&#34;</span>), <span style=color:#bd93f9>15</span>, <span style=color:#8be9fd;font-style:italic>true</span>);
</span></span></code></pre></div><p>Allowing to both covert objects into strings and concatenate them, without the
need of odd <code>std::ostringstream</code> objects all around the codebase.</p><p>A <code>TextReplace</code> class allows to do replace variable occurrences in a text with
user specified values. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>std<span style=color:#ff79c6>::</span>ifstream f(<span style=color:#f1fa8c>&#34;file.txt&#34;</span>);
</span></span><span style=display:flex><span>std<span style=color:#ff79c6>::</span>ostringstream out;
</span></span><span style=display:flex><span>text<span style=color:#ff79c6>::</span>TextReplace r;
</span></span><span style=display:flex><span>r.addVariable(<span style=color:#f1fa8c>&#34;var&#34;</span>, <span style=color:#f1fa8c>&#34;X&#34;</span>);
</span></span><span style=display:flex><span>r.addVariable(<span style=color:#f1fa8c>&#34;foo&#34;</span>, <span style=color:#f1fa8c>&#34;BAR&#34;</span>);
</span></span><span style=display:flex><span>r.replaceVariables(f, out);
</span></span></code></pre></div><p>and suppose <code>file.txt</code> contains:</p><pre tabindex=0><code>replace ${var} variables
with ${foo} their values ${p}.
</code></pre><p>the result of the replacement will be:</p><pre tabindex=0><code>replace X variables
with BAR their values ${p}.
</code></pre><p>Note that unknown variables are left untouched.</p><h1 id=website>Website<a hidden class=anchor aria-hidden=true href=#website>#</a></h1><p>I am not so proud of the website code, and I don&rsquo;t recommend looking at it in
detail. I did not have much experience in web development at that time, but I am
still quite happy with the result. Year ago it was not so obvious that a website
was mobile ready:</p><p><img loading=lazy src=home.png alt=img></p><p><img loading=lazy src=home-small.png alt=img></p><p>The website is just a bunch HTML + JavaScript pages. For the styling and the
responsive design I went with the immortals
<a href=http://getbootstrap.com/>Bootstrap</a> and <a href=https://jquery.com/>JQuery</a>, while
for the server side part I used the now infamous PHP.</p><p>Commands like start and stop monitoring and live view are issued by the frontend
by doing <code>GET</code> requests to pages under the <code>controller/</code> path. The PHP backend
listening that endpoint sends POSIX signals to the main executable. The
communication is not more complicated than that, because this first
implementation worked fine. I didn&rsquo;t bother changing it in something more
complicated.</p><p>The funniest part of the frontend is the live view though. Also in this case the
first implementation was good enough :). Basically the frontend uses an infinite
loop of Ajax requests<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> to a special <code>live.jpg</code> picture, which is served by a
custom FastCGI backend, written in C++. This is the one described in the
<a href=#fastcgi-backend>FastCGI backend</a> section.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>function <span style=color:#50fa7b>loadImage</span>(url, imageObj, target) {
</span></span><span style=display:flex><span>    imageObj.onload <span style=color:#ff79c6>=</span> function() {
</span></span><span style=display:flex><span>        target.setAttribute(&#39;src&#39;, <span style=color:#ff79c6>this</span>.src);
</span></span><span style=display:flex><span>        loadImage(url, imageObj, target);
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    imageObj.src <span style=color:#ff79c6>=</span> url <span style=color:#ff79c6>+</span> &#39;<span style=color:#ff79c6>?</span>_<span style=color:#ff79c6>=</span>&#39; <span style=color:#ff79c6>+</span> <span style=color:#ff79c6>new</span> Date().getTime();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$.ajax({ <span style=color:#8be9fd;font-style:italic>url</span>: &#39;..<span style=color:#ff79c6>/</span>controller<span style=color:#ff79c6>/</span>live.php&#39;,
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>dataType</span>: &#39;json&#39;,
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>cache</span>: <span style=color:#8be9fd;font-style:italic>false</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    .done(function(data) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (data.result <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>            $(&#39;.live<span style=color:#ff79c6>-</span>container&#39;).html(
</span></span><span style=display:flex><span>                &#39;<span style=color:#ff79c6>&lt;</span>img id<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;liveimg&#34;</span> <span style=color:#ff79c6>class</span>=&#34;<span style=color:#50fa7b>img</span><span style=color:#ff79c6>-</span>responsive<span style=color:#f1fa8c>&#34;&gt;&lt;/img&gt;&#39;</span>
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            var img <span style=color:#ff79c6>=</span> document.getElementById(&#39;liveimg&#39;);
</span></span><span style=display:flex><span>            loadImage(&#39;live.jpg&#39;, img, <span style=color:#ff79c6>new</span> Image);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>            <span style=color:#50fa7b>displayMessage</span>(&#39;.live<span style=color:#ff79c6>-</span>container&#39;,
</span></span><span style=display:flex><span>                &#39;<span style=color:#ff79c6>&lt;</span>h4<span style=color:#ff79c6>&gt;</span>Ooops...<span style=color:#ff79c6>&lt;/</span>h4<span style=color:#ff79c6>&gt;</span>&#39; <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                &#39;<span style=color:#ff79c6>&lt;</span>p<span style=color:#ff79c6>&gt;</span>&#39; <span style=color:#ff79c6>+</span> data.log <span style=color:#ff79c6>+</span> &#39;<span style=color:#ff79c6>&lt;/</span>p<span style=color:#ff79c6>&gt;</span>&#39;,
</span></span><span style=display:flex><span>                &#39;alert<span style=color:#ff79c6>-</span>danger&#39;);
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .fail(function(jqxhr, textStatus, errorThrown) {
</span></span><span style=display:flex><span>        displayMessage(&#39;.live<span style=color:#ff79c6>-</span>container&#39;,
</span></span><span style=display:flex><span>            &#39;<span style=color:#ff79c6>&lt;</span>h4<span style=color:#ff79c6>&gt;</span>Ooops...<span style=color:#ff79c6>&lt;/</span>h4<span style=color:#ff79c6>&gt;</span>&#39; <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>            &#39;<span style=color:#ff79c6>&lt;</span>p<span style=color:#ff79c6>&gt;</span>&#39; <span style=color:#ff79c6>+</span> errorThrown <span style=color:#ff79c6>+</span> &#39;<span style=color:#ff79c6>&lt;/</span>p<span style=color:#ff79c6>&gt;</span>&#39;,
</span></span><span style=display:flex><span>            &#39;alert<span style=color:#ff79c6>-</span>danger&#39;);
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>Yes, that&rsquo;s it. I didn&rsquo;t even have to shorten the code. Something that I
couldn&rsquo;t explain myself here was that in <code>loadImage</code> I couldn&rsquo;t use JQuery,
because it was much slower than the old style <code>setAttribute</code> and <code>image.src = url</code>. So I decided to live with that.</p><p><img loading=lazy src=live.png alt=img></p><p>The archive page shows pictures from previous alarms. Just don&rsquo;t look at the PHP
code behind that, it&rsquo;s really horrible crap. It can give you nightmares for days.</p><p><img loading=lazy src=archive.png alt=img></p><p>This is the carusel view:</p><p><img loading=lazy src=archive-carusel.png alt=img></p><p>This is the mobile version:</p><p><img loading=lazy src=archive-small.png alt=img></p><p>And this is the date selector for the alarm, in the mobile version:</p><p><img loading=lazy src=archive-small-select.png alt=img></p><h1 id=fastcgi-backend>FastCGI backend<a hidden class=anchor aria-hidden=true href=#fastcgi-backend>#</a></h1><p>One of the website backend components is ironically in a folder called
<code>frontend</code>. The name is unfortunate but it was meant to suggest an interface to
the main executable. It communicates with it via a ZeroMQ socket, and with the
web server through <a href=https://en.wikipedia.org/wiki/FastCGI>FastCGI</a>.</p><p>Interestingly enough, the first implementation was in Python, but it was too
slow. I had to re-implement it in C++, and now it&rsquo;s about three orders of
magnitude faster (yes, I really mean 1000X).</p><p>The <code>main.cpp</code> file contains all the logic:</p><ul><li>A webserver request is directed to the executable through the standard input
(which is ignored);</li><li>a picture is requested to the main antifurto executable through a ZeroMQ
request;</li><li>as soon as a reply arrives, it is immediately written to the standard output,
that is read by the webserver.</li></ul><p>There are a bunch of utility classes that have been used to make the code
cleaner, described in the following sections.</p><h2 id=zmqlazypirateclient>ZmqLazyPirateClient<a hidden class=anchor aria-hidden=true href=#zmqlazypirateclient>#</a></h2><p>This class implements the <a href=http://zguide.zeromq.org/page:all#Client-Side-Reliability-Lazy-Pirate-Pattern>Lazy pirate
pattern</a>
in ZeroMQ, which is a request-reply transition supporting socket reconnections.
This allows to start and stop the main executable and the webserver
independently; the connection between them will catch up automatically. When a
request-reply transaction is needed, this class will send the request and wait
until the reply comes, or a timeout expires. On timeout, the request is sent
again, until the maximum number of retrials is reached. At that point the
transaction is considered failed.</p><h2 id=stream-utilities>Stream utilities<a hidden class=anchor aria-hidden=true href=#stream-utilities>#</a></h2><p>The <code>StreamRedirector</code> class is responsible for redirecting the standard input
and output to FastCGI stream buffers, while <code>StreamReader</code> allows to buffer
reads from a stream (in this case the standard input). I actually don&rsquo;t remember
because it&rsquo;s a class instead of a simple function. Probably it&rsquo;s a non-sense.</p><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>In this post we had a look at the pet project I worked on for a while some years
ago. By skimming through this post again I realized that it is mostly a random
collection of impressions, design decisions and code snippets, so I don&rsquo;t know
how effective that is for a reader. However, for me it was important to wrap up,
because after all the time and effort spent, I didn&rsquo;t want to forget it, and I
also wanted to share my insights with the community.<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><p>My takeaways are that with this project I learned some stuff and I did something
useful for myself. I would definitely recommend working on things you really
need, as opposed to experimenting with technologies purposelessly. It really
helps to get them done (to a certain extent at least). Or at least that&rsquo;s the
only way I found preventing me to give up projects too early.<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><p>I hope this post gave you some interesting insights and maybe inspire you some
extensions, related projects or ideas. The code is open source on GitHub, under
<a href=https://github.com/mbrt/antifurto>mbrt/antifurto</a>, as I wrote earlier. I
encourage you to take a look yourself to some of the classes. You can also build
it and use it as is for your own security alarm. The deployment is kind of a
pain right now, because there are many dependencies and configuring the external
services is not exactly easy to do (Dropbox, mails, WhatsApp, etc). The
documentation is also somehow lacking; apologies for that.</p><p>That&rsquo;s all folks!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Take a look at the <a href=#meta-namespace>meta namespace</a> for the implementation.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>If you are curious, the <code>ErasedUniquePtr</code> class is briefly described in
the <a href=#meta-namespace>meta namespace</a> section.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Yes, I know WebSocket existed
already years ago, but really, at that time my phone didn&rsquo;t support them, and I
didn&rsquo;t feel like developing two different protocols.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>The license is GPL.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>See <a href=http://250bpm.com/blog:50>do finish your stuff</a> by Martin Sústrik.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.mbrt.dev/tags/c++/>c++</a></li><li><a href=https://blog.mbrt.dev/tags/raspberry-pi/>raspberry-pi</a></li><li><a href=https://blog.mbrt.dev/tags/code-review/>code-review</a></li></ul><nav class=paginav><a class=prev href=https://blog.mbrt.dev/posts/container-network/><span class=title>« Prev</span><br><span>Demystifying container networking</span>
</a><a class=next href=https://blog.mbrt.dev/posts/ripgrep/><span class=title>Next »</span><br><span>Ripgrep code review</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on x" href="https://x.com/intent/tweet/?text=Antifurto%3a%20home%20made%20security%20camera&amp;url=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f&amp;hashtags=c%2b%2b%2craspberry-pi%2ccode-review"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f&amp;title=Antifurto%3a%20home%20made%20security%20camera&amp;summary=Antifurto%3a%20home%20made%20security%20camera&amp;source=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f&title=Antifurto%3a%20home%20made%20security%20camera"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on whatsapp" href="https://api.whatsapp.com/send?text=Antifurto%3a%20home%20made%20security%20camera%20-%20https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on telegram" href="https://telegram.me/share/url?text=Antifurto%3a%20home%20made%20security%20camera&amp;url=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Antifurto: home made security camera on ycombinator" href="https://news.ycombinator.com/submitlink?t=Antifurto%3a%20home%20made%20security%20camera&u=https%3a%2f%2fblog.mbrt.dev%2fposts%2fantifurto%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.mbrt.dev/>mbrt blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>