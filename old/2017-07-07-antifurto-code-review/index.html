<!doctype html>
<html lang="en">
<head>
<title>Antifurto: home-made security camera</title>
<!-- 2017-07-08 Sat 00:21 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="content" class="container">

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="..">mbrt blog</a>
      <p class="navbar-text" ><a href="https://twitter.com/mbrt_dev" class="twitter-follow-button" data-show-count="false">Follow @mbrt_dev</a></p>
    </div>
  </div>
</nav>

<div class="row"><div class="col-md-9"><h1 class="title">Antifurto: home-made security camera</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
In February 2014 I had a very unpleasant surprise after coming back home from a
weekend in Berlin. Me and my girlfriend found out our apartment upside down
because of burglars. We suffered the loss not only of many of our belongings,
but worse, of our safety. We didn't feel safe in our home and we didn't feel
safe to leave it - not even for half an hour - for the fear to come back and
find somebody inside. It was with this mood that I started this project: totally
motivated to do something about it.
</p>

<p>
My goal was to install in the apartment a security alarm that was cheap, safe
and easy to use: something that I could trust. Nowadays there are plenty of
alternatives that satisfy all the requirements, but at that moment I couldn't
find anything like that. As I am a software engineer, I decided to jump into the
project and spend most of my free time on it (my girlfriend was only partially
happy with this resolution).
</p>

<p>
The end result was a Raspberry Pi with a camera module and a bunch of software,
in part taken from the open-source and in part written by me. As of the time of
writing, it's been running in production (namely my apartment) untouched for
more than three years now. Ironically my security camera lasted way more than my
apartment, because since then I already moved twice. So, quite a success for me.
</p>

<p>
And, if you're asking yourself if I had any burglars again since then, the
answer is no, luckily. But I had the opportunity to test it multiple times when
my parents have intruded my apartment without permission&#x2026;
</p>


<figure>
<p><img src="camera.jpg" class="img-responsive" alt="camera.jpg">
</p>
</figure>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Why?</h3>
<div class="outline-text-3" id="text-1-1">
<p>
At this point you can probably see my motivation behind the project, and also
the target audience: I needed something cheap that I, and my girlfriend could
use. This set of users was important for the design. It meant that the normal
usage should be simple, because my girlfriend (who is not a developer) had to
use it. The configuration and maintenance was however on me, so I didn't focus
on make that simple.
</p>

<p>
Today I'm open-sourcing the project. You can find it on GitHub under
<a href="https://github.com/mbrt/antifurto">mbrt/antifurto</a>. The name comes from an Italian word that means "security alarm".
It was a codename at the beginning, waiting to be changed in something better,
but in the end I didn't bother. So antifurto is still the name today.
</p>

<p>
Why am I open-sourcing that now, and not before? Why not keeping it closed
source? The project started to meet my needs, so I had no reason at the
beginning to open source something that was completely tied to my use case.
Nobody would have gotten any particular benefit from it. After some time however
it grown up into a more featured product. So, since at the time I wasn't happy
with my job, I considered starting a business and commercialize it. Long story
short, getting funds for startups in Italy is quite hard, so I needed money from
myself or my family. I then had to improve many parts of the project because I
needed to scale out for multiple customers. It was not only about my apartment
anymore. In the meantime competitors started to jump out from nowhere before I
even got started. I had an opportunity for a new job, so my motivations kinda
vaporized.
</p>

<p>
At the end of the day, there is not a commercial product, but a working
prototype, and an interesting experience to share. I decided to open-source it
now, because I needed time to put together this writeup and cleanup some
documentation. All things that I find boring, so it took me a while.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> What?</h3>
<div class="outline-text-3" id="text-1-2">
<p>
In this writeup I'm going to present the interesting bits of the project. I will
try to not focus too much on the details, but rather to present clearly the
high-level architecture, some design decisions and some interesting
implementation bits.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Features</h3>
<div class="outline-text-3" id="text-1-3">
<p>
The antifurto project is essentially a security camera that allows to monitor
what happens through the lenses of a single camera. When the camera detects
motion above a certain threshold, it sends notifications through WhatsApp and
emails and starts to record pictures. These are in turn saved to the local disk
and uploaded to a Dropbox folder. There is also a web portal (optimized for
desktop and mobile browsers) from which you can start and stop the monitoring, a
live view from which you can see images in real time and an archive page for the
past recordings. It's not possible to combine multiple cameras together: single
camera, single website.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Architecture</h2>
<div class="outline-text-2" id="text-2">
<p>
The project architecture is simple. Everything lives inside a Raspberry Pi,
period. There isn't a server component communicating with the camera, or
anything else. This is not an ideal architecture from the security point of
view, because all the keys, including SSL, Dropbox API secrets, email passwords,
etc are inside that box. It was the perfect solution for me, because instead of
a device and a server to manage, I had only one device. Moreover, the
development time was reduced because the architecture was simpler.
</p>

<p>
This unfortunately cannot work out if you want to provide the project to your
mother (assuming she's not a software developer). The Raspberry needs a non-zero
amount of maintenance, to provide a minimum amount of security. This includes
for example installing OS updates and rebooting the device periodically. The
keys need to be safe guarded inside the Raspberry itself, and re-generated in
case of leak. Again, this is not good if you want to do it properly, but I
preferred to do something quick and get it working as fast as I could.
</p>

<p>
Now for the details. The project is divided into three main parts:
</p>
<ul class="org-ul">
<li>the main <code>antifurto</code> executable (written in C++), which is responsible for the
monitoring and notifications;
</li>
<li>a web server (Apache + PHP), that serves the website from which you can see
the live stream, turn the monitoring on and off and view the archive;
</li>
<li>a FastCGI component that serves as a bridge between the webserver and the main
executable.
</li>
</ul>

<p>
There are also other small satellite components and scripts, such as:
</p>
<ul class="org-ul">
<li>a bash script to send emails with the <code>mail</code> command;
</li>
<li>python scripts to send WhatsApp notifications and upload pictures to Dropbox.
</li>
</ul>

<p>
You can see below a diagram of the high level architecture:
</p>


<figure>
<p><img src="overview.svg" class="img-responsive" alt="overview.svg">
</p>
</figure>

<p>
As you can see, the pictures come from the camera module and are processed by
the <code>antifurto</code> main executable. This decides whether to store the pictures on
the local hard drive (an SD card), and upload them on Dropbox or not. It also
decides, when to send notifications via email or WhatsApp messages. Whenever the
user decides to start a live view from the web interface, or start/stop the
monitoring, the backend sends a POSIX signal to the main process. If the desired
action was to start the live view, the main executable will start to send the
pictures over the <code>zmq</code> channel to the <code>antifurto.fcgi</code> component. Its only task
is to forward them to the webserver via an FCGI socket.
</p>

<p>
The design is heavily based on <a href="https://en.wikipedia.org/wiki/Observer_pattern">observers</a>, <a href="https://en.wikipedia.org/wiki/Type_erasure">type erasure</a>, <a href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composite reuse
principle</a> and <a href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">SOLID principles,</a> to minimize dependencies among components. Well,
at least I tried to keep those in mind.
</p>


<figure>
<p><img src="hierarchy.svg" class="img-responsive" alt="hierarchy.svg">
</p>
</figure>

<p>
In the diagram you can see the architecture of the main executable. Each box
represents a class. I didn't represent all of them, but only the most important.
For example I left out the utility classes like schedulers, queues, observer
lists. The dark boxes represent controller classes, which are responsible for
managing specific parts of the application. Controller classes manage all the
boxes connected via a "tilted square" arrow. This means that they both own those
classes (so they are responsible for their lifetime) and they know how to
operate them. Red boxes don't manage anything, but they provide a functionality
either for other classes or talk to external services.
</p>

<p>
One important thing to notice is that each class is owned by one and only one
controller. The architecture and the lifetime of the resources are very simple
and clear in this way. A consequence is that classes can be tested individually
much more easily, since there are no cyclical dependencies, and children don't
know anything about their parents.
</p>

<p>
In the diagram you can also see what are the inputs and outputs of each class.
Red arrows are inputs, and dark arrows are outputs. You can see that I didn't
connect explicitly those arrows. Why? Because they are loose connections.
Outputs are provided in the form of observers<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>, and classes interested in
pictures don't know anything about the <a href="#sec-3-3-2">Camera</a> class. So, controllers are
responsible to "wire" those connections, by registering themselves to the inputs
they need and forward them to the classes they manage. For example the
<a href="#sec-3-5-1">RecordingController</a> class register itself to both alarm notifications (provided
by the <a href="#sec-3-3-1">MotionDetector</a>) and the picture stream (provided by the <a href="#sec-3-3-2">Camera</a>). It is
managed by the <a href="#sec-3-2-1">MonitorController</a>, so whenever the monitoring functionality is
stopped, the recording classes can be safely deleted. The <code>RecordingController</code>
then listens to alarm events and whenever one occurs, it forwards the pictures
stream directly to the <a href="#sec-3-5-2">PictureArchive</a> and the <a href="#sec-3-5-3">DropboxUploader</a>.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Main executable</h2>
<div class="outline-text-2" id="text-3">
<p>
In this long section I'm going to talk about the internal details of the main
executable, called <code>antifurto</code> for a very lack of fantasy.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Main class</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The main class is called <code>Antifurto</code>, what a surprise! It is responsible to
start and stop the monitoring and the live view, by orchestrating the resources
involved. It uses a <code>Config</code> structure for the configuration, that comes from
the command line and the configuration file. It can be used as an external
library, as most of the components in this project, since it is self contained.
</p>

<p>
It contains all the controllers, that are described in the <a href="#sec-3-2">Main controllers</a>
section, and the implementation details are hidden from the header file behind a
<a href="https://herbsutter.com/gotw/_100/">Pimpl</a>.
</p>

<p>
The interface is very simple: it takes a configuration and the user can control
when to start and stop monitoring and live view from four public methods:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">Antifurto</span>
{
<span style="color: #4f97d7; font-weight: bold;">public</span>:
  <span style="color: #bc6ec5; font-weight: bold;">Antifurto</span>(<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">Configuration</span>&amp; <span style="color: #7590db;">c</span>, <span style="color: #ce537a; font-weight: bold;">bool</span> <span style="color: #7590db;">maintenanceNeeded</span> = <span style="color: #a45bad;">true</span>);

  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">startMonitoring</span>();
  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">stopMonitoring</span>();

  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">startLiveView</span>();
  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">stopLiveView</span>();

<span style="color: #4f97d7; font-weight: bold;">private</span>:
  <span style="color: #a45bad;">meta</span>::<span style="color: #ce537a; font-weight: bold;">ErasedUniquePtr</span>&lt;AntifurtoImpl&gt; <span style="color: #7590db;">pimpl_</span>;
};
</pre>
</div>

<p>
So, this class is all about the very high level use cases of configuring,
starting and stopping the main functionalities.<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>
</p>

<p>
These functions are a bit less simple than one can at first imagine. For example
the <code>startMonitoring</code> is anynchronous and starts the monitoring only after a
configurable timeout. This is because after the start, the person may need to
get out the way before the monitoring effectively starts. The default I'm using
for myself is one minute. At the same time, the function needs to check if the
user cancels the start request before the timer goes off. I needed to put some
attention in the interaction between start, stop and the destructor. The
<a href="#sec-3-2-2">CameraController</a> lifetime depends on whether one between the monitoring and the
live view functionalities are on:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">handleCameraControllerNeed</span>()
{
  <span style="color: #4f97d7; font-weight: bold;">if</span> ((liveViewActive_ || monitorActive_) &amp;&amp; <span style="color: #a45bad;">!</span>camera_)
    camera_.reset(<span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">CameraController</span>());
  <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #a45bad;">!</span>liveViewActive_ &amp;&amp; <span style="color: #a45bad;">!</span>monitorActive_)
    camera_.reset();
}
</pre>
</div>

<p>
This method is called by all the four external methods, to factor out this
common part.
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Main controllers</h3>
<div class="outline-text-3" id="text-3-2">
<p>
In this section I'm going to describe the three controllers that manage the
monitoring, live view and the camera sub-components.
</p>
</div>

<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> MonitorController</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
This class controls the monitoring functionality life cycle. It delegates to its
sub-components tasks such as motion detection, and notifications. The most
important part of its public interface is the <code>examinePicture</code> function:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">examinePicture</span>(<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">Picture</span>&amp; <span style="color: #7590db;">picture</span>);
</pre>
</div>

<p>
The <a href="#sec-3-1">Main class</a> calls this function whenever a new picture comes out of the
camera.
</p>

<p>
Another interesting bit is the way this class asks for the upper level
controller to change the picture capture interval, or to stop the recording
altogether. To break cyclical dependencies, the upper level class has to
instantiate the <code>MonitorController</code> by passing a couple of callbacks. One of
them is the <code>SetPicturesInterval</code>:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">SetPicturesInterval</span> = <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">function</span>&lt;<span style="color: #ce537a; font-weight: bold;">void</span>(<span style="color: #a45bad;">std</span>::<span style="color: #a45bad;">chrono</span>::<span style="color: #7590db;">milliseconds</span>)&gt;;
</pre>
</div>

<p>
that is used whenever some motion is detected. In that case, the
<code>MonitorController</code> asks for an increase of the capture frequency. It's also
useful whenever nothing is going on, to decrease the capture frequency and so
save energy:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">MonitorController</span>::<span style="color: #bc6ec5; font-weight: bold;">onAlarmStateChanged</span>(<span style="color: #a45bad;">MotionDetector</span>::<span style="color: #ce537a; font-weight: bold;">State</span> <span style="color: #7590db;">state</span>)
{
  <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">State</span> = <span style="color: #a45bad;">MotionDetector</span>::State;

  <span style="color: #4f97d7; font-weight: bold;">switch</span> (state) {
  <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">State</span>::NO_ALARM:
    setPicturesInterval_(<span style="color: #a45bad;">config</span>::monitorCycleDuration());
    <span style="color: #4f97d7; font-weight: bold;">break</span>;
  <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">State</span>::PRE_ALARM:
    setPicturesInterval_(<span style="color: #a45bad;">config</span>::monitorCycleDurationOnAlarm());
    <span style="color: #4f97d7; font-weight: bold;">break</span>;
  <span style="color: #4f97d7; font-weight: bold;">default</span>:
    <span style="color: #4f97d7; font-weight: bold;">break</span>;
  }
  <span style="color: #a45bad;">log</span>::info() &lt;&lt; <span style="color: #2d9574;">"Alarm state: "</span> &lt;&lt; state;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> CameraController</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
This class is responsible to take pictures from a camera at a given rate. A user
of this class can register an observer and specify the rate at which the
pictures have to be taken:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">CameraController</span>
{
<span style="color: #4f97d7; font-weight: bold;">public</span>:
  <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Subject</span> = <span style="color: #a45bad;">meta</span>::<span style="color: #ce537a; font-weight: bold;">Subject</span>&lt;<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">Picture</span>&amp;&gt;;
  <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Observer</span> = <span style="color: #a45bad;">Subject</span>::Observer;
  <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Registration</span> = <span style="color: #a45bad;">Subject</span>::Registration;
  <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Period</span> = <span style="color: #a45bad;">std</span>::<span style="color: #a45bad;">chrono</span>::milliseconds;

  <span style="color: #2aa1ae;">/// </span><span style="color: #2aa1ae;">Set the pictures capture rate</span>
  <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setDesiredPeriod</span>(<span style="color: #ce537a; font-weight: bold;">Registration</span> <span style="color: #4f97d7; font-weight: bold;">const</span>&amp; <span style="color: #7590db;">r</span>, <span style="color: #ce537a; font-weight: bold;">Period</span> <span style="color: #7590db;">period</span>);

  <span style="color: #2aa1ae;">/// </span><span style="color: #2aa1ae;">Add an observer to the pictures flow</span>
  <span style="color: #ce537a; font-weight: bold;">Registration</span> <span style="color: #bc6ec5; font-weight: bold;">addObserver</span>(<span style="color: #ce537a; font-weight: bold;">Observer</span> <span style="color: #7590db;">observer</span>, <span style="color: #ce537a; font-weight: bold;">Period</span> <span style="color: #7590db;">desiredPeriod</span>);

  <span style="color: #2aa1ae;">// </span><span style="color: #2aa1ae;">...</span>
};
</pre>
</div>

<p>
This uses the observer pattern, implemented as an utility in the <a href="#sec-3-7-1">meta namespace</a>.
</p>

<p>
Every time a picture is taken, the observer callback is called. If multiple
observers are interested in different capture rates, the maximum rate is used.
This means that an observer specifies the minimum speed, but it could get
pictures at a higher speed, if it's necessary for other observers.
</p>

<p>
To implement this functionality, in a separate thread a <code>Metronome</code> class sleeps
the required time, and then the <code>Camera</code> class takes a picture. Every time an
observer is registered or de-registered, the sleep time is updated.
</p>
</div>
</div>

<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> LiveViewController</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
This class starts and stops the live view functionality. It doesn't implement
the functionality itself; it just controls the lifetime of a <a href="#sec-3-4">LiveView</a> object.
From the outside it takes pictures and the start and stop commands.
</p>

<p>
Whenever a picture comes, it is forwarded to the internal <code>LiveView</code> object. To
detect when the user is not interested in the live view anymore, there is a
primitive control flow, which is basically a fixed queue of pictures sent to the
browser. When the client doesn't request them, the queue fills up. After a
certain timeout with a full queue, the <code>LiveViewController</code> simply stops the
live view:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">if</span> (liveView_-&gt;addPicture(p))
    lastPictureWrittenTime_ = <span style="color: #a45bad;">system_clock</span>::now();
<span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #a45bad;">system_clock</span>::now() - lastPictureWrittenTime_ &gt; timeout_)
    stop();
</pre>
</div>

<p>
To do this, the internal <code>LiveView</code> object simply informs whether it has been
able to process the image or not, and if not, the timeout is checked.
</p>

<p>
The <code>stop</code> function invokes a callback, that asks to be de-registered from the
stream of pictures.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Picture's capture</h3>
<div class="outline-text-3" id="text-3-3">
</div><div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> MotionDetector</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
This class uses the <a href="http://opencv.org/">OpenCV</a> library to examine the pictures flow and determine if
something is moving. It implements the observer pattern to notify the observers
for the current state. The motion detection code is pretty simple:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">cv</span>::absdiff(curr_, p, currDiff_);
<span style="color: #a45bad;">cv</span>::bitwise_and(prevDiff_, currDiff_, motion_);
<span style="color: #4f97d7; font-weight: bold;">if</span> (motionHappened())
    onMotionDetected();
<span style="color: #4f97d7; font-weight: bold;">else</span>
    onNoMotion();
<span style="color: #2aa1ae;">// </span><span style="color: #2aa1ae;">save</span>
<span style="color: #a45bad;">std</span>::swap(prevDiff_, currDiff_);
curr_ = p;
</pre>
</div>

<p>
The code works with three pictures: the current one and the last two. Two images
are computed out of them by making a difference (i.e. subtracting the gray
values of the pixels one by one) between the first with the second and the
second with the third. Then a "bitwise and" is computed between them. Random
noise will be filtered out, since it's unlikely to stay still for three frames,
and the image will be almost completely black. Whenever something moves however,
certain areas of the pictures will differ among the three frames, and so the
difference will produce white pixels. These pixels are then counted in
<code>motionHappened()</code>, and if they exceed a certain threshold, then motion is
detected.
</p>

<p>
There is an additional layer of protection against errors, and it's a state
machine that counts how many consecutive moving frames have been detected. These
states are used to better control energy saving, picture capture and alarm
notifications.
</p>


<figure>
<p><img src="motion-detector.svg" class="img-responsive" alt="motion-detector.svg">
</p>
</figure>

<p>
Every time a transition occurs in this state machine, all the observers are
notified. It will be up to them to take the right action.
</p>

<p>
Everything starts from the <code>IDLE</code> state. Whenever some motion is detected, the
state becomes <code>PRE_ALARM</code>. If no more motion frames are detected, the state goes
back to <code>IDLE</code>. If the motion continues however, the state machine transitions
to <code>ALARM</code>. It stays there while the motion continues. When it stops, the state
goes to the <code>STILL</code> state. This means that even though nothing is moving, for
some time, the alert level is still on alarm. Indeed, if some motion happens
again, the state turns immediately to <code>ALARM</code> again. If instead nothing happens
for some time, the state goes back to <code>IDLE</code>.
</p>

<p>
In this way we have decoupled the abstract states in which the system may be
with the actions the various components have to take to respond.
</p>
</div>
</div>

<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2"><span class="section-number-4">3.3.2</span> Camera</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
The camera type is statically determined in <code>StaticConfig.hpp</code>. In the
Raspberry-Pi case, there is a homegrown version implemented by <code>PiCamera</code> that
uses a slightly modified version of the <code>picam</code> library, that I found <a href="http://robotblogging.blogspot.nl/2013/10/an-efficient-and-simple-c-api-for.html">here</a>. This
library is a simple interface on top of the Raspberry <a href="https://github.com/mbrt/userland">userland</a> library I forked
just to ease the build. To capture images outside the Raspberry world I instead
opted for the <a href="http://opencv.org/">OpenCV</a> library and implemented <code>CvCamera</code>. Now, I have to admit
that the <code>CvCaptureRAII</code> class might look a bit weird, but it was an attempt to
implement the camera resource through <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII</a>. I took inspiration from Martinho
Fernandez <a href="https://rmf.io/cxx11/rule-of-zero">rule of zero</a> blog post and the <a href="http://scottmeyers.blogspot.nl/2014/03/a-concern-about-rule-of-zero.html">concern about the rule of zero</a> by Scott
Meyers. To discuss this in detail I would need an entire blog post in itself, so
I'll just point you to these valuable resources. To be honest I'm not very
satisfied by its look and feel now.
</p>

<p>
With the same spirit I implemented the capture resource for <code>PiCamera</code>, which is
just a one liner:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">unique_ptr</span>&lt;CCamera, <span style="color: #ce537a; font-weight: bold;">void</span>(*)(<span style="color: #ce537a; font-weight: bold;">CCamera</span>*)&gt; <span style="color: #7590db;">capture_</span>;
</pre>
</div>

<p>
It uses the non-so-well-known custom deleter feature of <code>std::unique_ptr</code>.
Again, look at the Fernandez's post for an explanation on why I didn't just
implemented a stupid destructor for <code>PiCamera</code>. Everything is handled
automatically, since in the constructor I pass the resource, and the deleter
function to be called in destruction (namely <code>picam_stop_camera</code>):
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">PiCamera</span>::<span style="color: #bc6ec5; font-weight: bold;">PiCamera</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">width</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">height</span>)
  : width_(width), height_(height)
  , capture_(::picam_start_camera(width, height, <span style="color: #a45bad;">10</span>, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">false</span>),
             &amp;::picam_stop_camera)
{
  <span style="color: #2aa1ae;">// </span><span style="color: #2aa1ae;">...</span>
}
</pre>
</div>

<p>
These two different implementations of the camera resource were not intended to
be used at the same time: one was only for the Raspberry Pi hardware, and the
other for PC's with USB cameras. For this reason I didn't introduce any common
interface, and just used a compile time define and a <code>typedef</code> to switch between
them:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">namespace</span> <span style="color: #a45bad;">antifurto</span> {
<span style="color: #4f97d7; font-weight: bold;">namespace</span> <span style="color: #a45bad;">config</span> {

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span>(ANTIFURTO_RASPBERRY)
    <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Camera</span> = <span style="color: #a45bad;">antifurto</span>::PiCamera;
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Camera</span> = <span style="color: #a45bad;">antifurto</span>::CvCamera;
<span style="color: #bc6ec5;">#endif</span>

}}
</pre>
</div>

<p>
The code will simply refer to the <code>antifurto::config::Camera</code> type to get a
capture resource. I just needed to make sure their public interface (i.e. the
public methods) are the same, so the two classes could be used interchangeably.
</p>

<p>
This trick is quite handy if you don't need runtime polymorphism, but honestly
it's a bit overkill for this project.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> LiveView</h3>
<div class="outline-text-3" id="text-3-4">
<p>
This class is managed by the <a href="#sec-3-2-3">LiveViewController</a> and is responsible to forward
pictures to a <a href="http://zeromq.org/">ZeroMQ</a> socket. It has a single producer / single consumer queue
(see the <a href="#sec-3-7-4">concurrency</a> section) and a worker thread to offload the communication.
</p>

<p>
The interesting part about this class is the use of a non-blocking lock-free
queue, that allows minimum interruption for the producer. Whenever the queue is
full, the images are discarded, and the caller is notified, in order to make
some control flow, without interrupting the images flow.
</p>

<p>
For the communication to the webserver we use the <a href="http://zguide.zeromq.org/page:all#Ask-and-Ye-Shall-Receive">request-reply pattern</a> in
ZeroMQ. It's a simple protocol where at very request corresponds one reply.
Reconnections are implemented in the <a href="#sec-5">FastCGI backend</a>, with the
<a href="#sec-5-1">ZmqLazyPirateClient</a> class.
</p>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Picture recording</h3>
<div class="outline-text-3" id="text-3-5">
</div><div id="outline-container-sec-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> RecordingController</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
This class is responsible for managing the registration of the pictures while an
alarm is active. It accepts pictures with the <code>void addPicture(Picture p)</code>
method and registers itself to the <a href="#sec-3-3-1">MotionDetector</a> to know when to start and stop
the recording. This is done by saving Jpeg pictures on the local file system (by
using <a href="#sec-3-5-2">PictureArchive</a>) and uploading them to Dropbox (by using <a href="#sec-3-5-3">DropboxUploader</a>).
</p>

<p>
The state machine is quite simple:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">RecordingController</span>::<span style="color: #bc6ec5; font-weight: bold;">onAlarmStateChanged</span>(<span style="color: #a45bad;">MotionDetector</span>::<span style="color: #ce537a; font-weight: bold;">State</span> <span style="color: #7590db;">state</span>)
{
    <span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">State</span> = <span style="color: #a45bad;">MotionDetector</span>::State;
    <span style="color: #4f97d7; font-weight: bold;">switch</span> (state) {
    <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">State</span>::NO_MOTION:
        archive_.stopSaving();
        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">State</span>::NO_ALARM:
        enqueueOlderPictures();
        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">State</span>::ALARM:
        archive_.startSaving();
        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">State</span>::PRE_ALARM:
    <span style="color: #4f97d7; font-weight: bold;">default</span>:
        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    }
}
</pre>
</div>

<p>
Whenever the motion detector notifies this class about an alarm, it starts to
save the pictures. When there is no motion involved (even if the alarm is still
active), the recording is stopped.
</p>

<p>
Saving pictures in real time is important, both on disk and online. If there is
a slow upload for any reason, the queue between the producer (the <a href="#sec-3-3-2">Camera</a>) and
the consumer (the uploader), grows. This would mean that by looking at the
pictures online, the delay between capture and upload will grow more and more
over time during alarms. To avoid this behavior, the queue size is limited, and
whenever it's full, the coming pictures are queued in a secondary one:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">RecordingController</span>::<span style="color: #bc6ec5; font-weight: bold;">onPictureSaved</span>(<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span>&amp; <span style="color: #7590db;">fileName</span>)
{
    <span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #a45bad;">!</span>uploadWorker_.enqueue(fileName)) {
        <span style="color: #a45bad;">log</span>::info() &lt;&lt; <span style="color: #2d9574;">"Failed to upload picture to Dropbox: queue is full"</span>;
        <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">unique_lock</span>&lt;<span style="color: #a45bad;">std</span>::mutex&gt; <span style="color: #bc6ec5; font-weight: bold;">lock</span>(toUploadAfterQueueMutex_);
        toUploadAfterQueue_.emplace(fileName);
    }
}
</pre>
</div>

<p>
This ensures a fixed maximum delay between capture and upload, just by skipping
pictures now and then, when the queue is full. All the missing pictures are
instead uploaded when the alarm is not active anymore (the <code>case
State::NO_ALARM:</code> above):
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">while</span> (<span style="color: #a45bad;">!</span>toUploadAfterQueue_.empty()) {
    <span style="color: #4f97d7; font-weight: bold;">if</span> (uploadWorker_.enqueue(toUploadAfterQueue_.front()))
        toUploadAfterQueue_.pop();
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        <span style="color: #4f97d7; font-weight: bold;">break</span>;
}
<span style="color: #2aa1ae;">// </span><span style="color: #2aa1ae;">if the queue is not empty, we need to schedule another upload cycle</span>
<span style="color: #4f97d7; font-weight: bold;">if</span> (<span style="color: #a45bad;">!</span>toUploadAfterQueue_.empty()) {
    <span style="color: #a45bad;">log</span>::info() &lt;&lt; <span style="color: #2d9574;">"Cannot empty the upload queue. Schedule a new upload"</span>;
    scheduler_.scheduleAfter(<span style="color: #a45bad;">std</span>::<span style="color: #a45bad;">chrono</span>::minutes(<span style="color: #a45bad;">10</span>), [<span style="color: #4f97d7; font-weight: bold;">this</span>] {
          enqueueOlderPictures();
    });
 }
</pre>
</div>

<p>
The logic is a bit brutal but it works. While there is still something to
upload, it adds the pictures to the upload queue. If the queue gets full again,
a new procedure is scheduled after 10 minutes.
</p>

<p>
There is another maintenance procedure, to avoid a full hard drive. Every 24
hours, older pictures are removed. Depending on the configuration, only a
certain amount of days are kept:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #2aa1ae;">// </span><span style="color: #2aa1ae;">schedule maintenance at every midnight</span>
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #4f97d7; font-weight: bold;">namespace</span> <span style="color: #a45bad;">std</span>::<span style="color: #a45bad;">chrono</span>;
<span style="color: #4f97d7; font-weight: bold;">auto</span> <span style="color: #7590db;">maintenanceWork</span> = [<span style="color: #4f97d7; font-weight: bold;">this</span>] { performMaintenance(); };
scheduler_.scheduleAt(<span style="color: #a45bad;">concurrency</span>::tomorrow() + minutes(<span style="color: #a45bad;">1</span>), [=] {
    performMaintenance();
    scheduler_.scheduleEvery(hours(<span style="color: #a45bad;">24</span>), maintenanceWork);
});
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5-2" class="outline-4">
<h4 id="sec-3-5-2"><span class="section-number-4">3.5.2</span> PictureArchive</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
This class saves pictures in Jpeg format to a given folder. It takes a stream of
pictures and two commands: <code>startSaving</code> and <code>stopSaving</code>. When the recording is
started, not only the next picture is saved, but also some of the previous. This
object has indeed a fixed sized circular buffer that allows to retroactively
save the images right before an alarm popped up. It also allows observers to
register for when a picture is saved to disk, getting the file name.
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">PictureArchive</span>::<span style="color: #bc6ec5; font-weight: bold;">save</span>(<span style="color: #ce537a; font-weight: bold;">Picture</span>&amp; <span style="color: #7590db;">p</span>, <span style="color: #ce537a; font-weight: bold;">Clock</span> <span style="color: #7590db;">t</span>)
{
    <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #7590db;">filename</span>{ <span style="color: #a45bad;">fs</span>::concatPaths(currentFolder_,
        <span style="color: #a45bad;">text</span>::toString(t, <span style="color: #a45bad;">text</span>::<span style="color: #a45bad;">ToStringFormat</span>::FULL, <span style="color: #2d9574;">'-'</span>, <span style="color: #2d9574;">'_'</span>) + <span style="color: #2d9574;">".jpg"</span>)};

    <span style="color: #a45bad;">cv</span>::putText(p, <span style="color: #a45bad;">text</span>::toString(t, <span style="color: #a45bad;">text</span>::<span style="color: #a45bad;">ToStringFormat</span>::SHORT, <span style="color: #2d9574;">'/'</span>, <span style="color: #2d9574;">' '</span>),
                <span style="color: #a45bad;">cv</span>::Point(<span style="color: #a45bad;">30</span>,<span style="color: #a45bad;">30</span>), CV_FONT_HERSHEY_COMPLEX_SMALL, <span style="color: #a45bad;">0.8</span>,
                <span style="color: #a45bad;">cv</span>::Scalar(<span style="color: #a45bad;">200</span>,<span style="color: #a45bad;">200</span>,<span style="color: #a45bad;">250</span>), <span style="color: #a45bad;">1</span>, CV_AA);
    <span style="color: #a45bad;">cv</span>::imwrite(filename, p, {CV_IMWRITE_JPEG_QUALITY, <span style="color: #a45bad;">90</span>});
    notifyObservers(filename);
}
</pre>
</div>

<p>
The picture gets a timestamp text overlay on the top left corner and then is
saved on disk.
</p>

<p>
On the bad side there is the ring buffer, which is actually not a ring buffer at
all. Pictures are pushed to the end of a vector. The beginning is then deleted
by moving all the other elements at the previous index. Not pretty, not fast,
but all in all it works. Moving to a proper circular buffer should not be very
hard.
</p>
</div>
</div>

<div id="outline-container-sec-3-5-3" class="outline-4">
<h4 id="sec-3-5-3"><span class="section-number-4">3.5.3</span> DropboxUploader</h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
This class is responsible for uploading files to a Dropbox account, by using an
external <code>dropbox_uploader.sh</code> script. It just generates a configure file for
it, starting from the Antifurto's configuration, and uploads a file when
requested, by launching an external process. Nothing fancy here, I just forked
<a href="https://github.com/andreafabrizi/Dropbox-Uploader">andreafabrizi/Dropbox-Uploader</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Notifications</h3>
<div class="outline-text-3" id="text-3-6">
<p>
Two types of notifications are supported: WhatsApp and emails. WhatsApp have
been historically fighting against bots. For this reason the phone numbers I
used as source for notifications have been banned. I don't recommend using it
for this reason. A much more sane approach would have been to implement a
Telegram bot instead, but at that time they didn't exist. Email notifications
are instead much more safe and reliable to use. For those two functionalities we
have two very similar controllers: <code>WhatsappNotificationController</code> and
<code>MailNotificationController</code>, that register themselves to the <a href="#sec-3-3-1">MotionDetector</a> and
whenever there is an alarm, they try to use their counterpart
(<a href="#sec-3-6-1">WhatsappNotifier</a> and <a href="#sec-3-6-2">MailNotifier</a>) to send the notifications
asynchronously. They also take care of retrials in case of errors, and avoid
sending too many of them in a short period of time, to avoid flooding the
receivers.
</p>
</div>

<div id="outline-container-sec-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> WhatsappNotifier</h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
This class manages WhatsApp notifications. Whenever <code>send(std::string const&amp;
dest, std::string const&amp; msg)</code> is called, it sends a message with <a href="https://github.com/mbrt/yowsup">yowsup-cli</a> by
spawning an external process. This class just generates the configuration file
needed by Yowsup from the main process configuration and takes care of its
execution.
</p>
</div>
</div>

<div id="outline-container-sec-3-6-2" class="outline-4">
<h4 id="sec-3-6-2"><span class="section-number-4">3.6.2</span> MailNotifier</h4>
<div class="outline-text-4" id="text-3-6-2">
<p>
This class is responsible for sending emails.
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">send</span>(<span style="color: #ce537a; font-weight: bold;">ContactList</span> <span style="color: #4f97d7; font-weight: bold;">const</span>&amp; <span style="color: #7590db;">dest</span>,
          <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #4f97d7; font-weight: bold;">const</span>&amp; <span style="color: #7590db;">sender</span>,
          <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #4f97d7; font-weight: bold;">const</span>&amp; <span style="color: #7590db;">subject</span>,
          <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #4f97d7; font-weight: bold;">const</span>&amp; <span style="color: #7590db;">body</span>);
</pre>
</div>

<p>
It calls an external bash script that uses the Unix <code>mail</code> utility, to send the
mail.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7"><span class="section-number-3">3.7</span> Utility libraries</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Here I present some random notes on the utility namespaces that help with design
patterns, concurrency, filesystem and logging. Some of them are a bit
over-engineered but in hobby projects you also need to have some fun, don't you?
:)
</p>
</div>

<div id="outline-container-sec-3-7-1" class="outline-4">
<h4 id="sec-3-7-1"><span class="section-number-4">3.7.1</span> meta namespace</h4>
<div class="outline-text-4" id="text-3-7-1">
<p>
This namespace contains some generic patterns and algorithms that do not depend
on the specific details of the project itself. In <code>Observer.hpp</code> you can find a
generic implementation of the <a href="https://en.wikipedia.org/wiki/Observer_pattern">observer pattern</a>. A <code>Subject</code> wants to provide
observers the possibility to register for events. The class takes a variadic
number of type parameters, that will be used in the notification. For example:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">Subject</span>&lt;<span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">float</span>&gt; <span style="color: #7590db;">s</span>;
<span style="color: #4f97d7; font-weight: bold;">auto</span> <span style="color: #7590db;">reg</span> = s.registerObserver([](<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">a</span>, <span style="color: #ce537a; font-weight: bold;">float</span> <span style="color: #7590db;">b</span>) { print(a, b); });
s.notify(<span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">3.14</span>);
</pre>
</div>

<p>
in this example we want to notify our observer with an integer and a float. To
do that we just need to declare <code>Subject</code> with the right parameters. This will
in turn be able to accept observers that respect the <code>std::function&lt;void(int,
float)&gt;</code> signature.
</p>

<p>
Interesting:
</p>
<ul class="org-ul">
<li>the registration returns a token that when goes out of scope unregisters the
observer automatically;
</li>
<li>it is possible to register and unregister observers within notification
callbacks (re-entrant calls are supported).
</li>
</ul>

<p>
Other small utilities are also present, like <code>ErasedUniquePtr</code>, which provides
a unique pointer with an erased deleter. This is an useful workaround to a
subtle problem when you want to forward declare a class and use it in an unique
pointer. For more details see the <a href="https://akrzemi1.wordpress.com/2013/12/11/type-erasure-part-iii/">type erasure post</a> of Andrzej's blog.
</p>
</div>
</div>

<div id="outline-container-sec-3-7-2" class="outline-4">
<h4 id="sec-3-7-2"><span class="section-number-4">3.7.2</span> fs</h4>
<div class="outline-text-4" id="text-3-7-2">
<p>
This namespace contains simple path manipulation utilities to concatenate
multiple paths with a single call:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #7590db;">p</span> = <span style="color: #a45bad;">fs</span>::concatPaths(<span style="color: #2d9574;">"/var/log"</span>, bar, <span style="color: #2d9574;">"file.txt"</span>);
</pre>
</div>

<p>
This is similar to what <code>boost::filesystem</code> does, but in a more functional way.
</p>
</div>
</div>

<div id="outline-container-sec-3-7-3" class="outline-4">
<h4 id="sec-3-7-3"><span class="section-number-4">3.7.3</span> log</h4>
<div class="outline-text-4" id="text-3-7-3">
<p>
This namespace contains logging utilities. The focus of this library was to
provide a fast and simple logging without using macro shenanigans.
</p>

<p>
You can use it with a call to a free function, that will return the proper
logger:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">log</span>::debug() &lt;&lt; <span style="color: #2d9574;">"my log here "</span> &lt;&lt; <span style="color: #a45bad;">15</span>;
</pre>
</div>

<p>
There is also a <code>reload</code> function. When a log rotation occurs it will simply
close the old file (that has been rotated) and open a new file in the same
place. Ignored log levels are implemented by returning a logger that writes to a
<code>NullSink</code>, which simply does nothing. Interestingly cryptic is the
implementation of an <code>std::outstream</code> that does nothing. You can find it in
<code>log/NullStream.hpp</code>.
</p>
</div>
</div>

<div id="outline-container-sec-3-7-4" class="outline-4">
<h4 id="sec-3-7-4"><span class="section-number-4">3.7.4</span> concurrency</h4>
<div class="outline-text-4" id="text-3-7-4">
<p>
This namespace contains some classes that deal with concurrency. An interesting
one is <code>SpScQueue</code>, that wraps a worker thread and allows to enqueue work items
for it. The type of the work item is templated, to maximize reusability. The
queue is a lock-free implementation that can be chosen at compile time among a
fixed-size and a dynamically allocated one. The former is preferred in case the
maximum queue size is known at compile time.
</p>

<p>
As a side note I would like to add here that since the project deals with
real-time data, avoiding dynamic allocations can be critical. We used fixed
bound queues in all places for this reason.
</p>

<p>
Another interesting class in this namespace is the <code>TaskScheduler</code>. It provides
the possibility to schedule tasks at certain time points, either one-shot or
periodic:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">scheduleAt</span>(<span style="color: #a45bad;">Clock</span>::<span style="color: #ce537a; font-weight: bold;">time_point</span> <span style="color: #7590db;">t</span>, <span style="color: #7590db;">Task</span> w);
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">scheduleAfter</span>(<span style="color: #a45bad;">Clock</span>::<span style="color: #ce537a; font-weight: bold;">duration</span> <span style="color: #7590db;">d</span>, <span style="color: #7590db;">Task</span> w);
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">scheduleEvery</span>(<span style="color: #a45bad;">Clock</span>::<span style="color: #ce537a; font-weight: bold;">duration</span> <span style="color: #7590db;">d</span>, <span style="color: #7590db;">Task</span> w);
</pre>
</div>

<p>
The work items are processed one after the other in a worker thread, so delays
added by one task impact on the next ones. It is for this reason used only for
short tasks.
</p>
</div>
</div>

<div id="outline-container-sec-3-7-5" class="outline-4">
<h4 id="sec-3-7-5"><span class="section-number-4">3.7.5</span> ipc</h4>
<div class="outline-text-4" id="text-3-7-5">
<p>
This namespace contains classes related to child processes and inter-process
communication. There is a <code>forkAndCall</code> function, that forks the process, calls
a the given function and returns the function result by using the child process
exit code:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #2aa1ae;">/// </span><span style="color: #2aa1ae;">This function fork the process, calls the function in the child process,</span>
<span style="color: #2aa1ae;">/// </span><span style="color: #2aa1ae;">wait for completion and returns the function return value.</span>
<span style="color: #ce537a; font-weight: bold;">ChildProcess</span> <span style="color: #bc6ec5; font-weight: bold;">forkAndCall</span>(<span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">function</span>&lt;<span style="color: #ce537a; font-weight: bold;">int</span>()&gt; <span style="color: #7590db;">f</span>);
</pre>
</div>

<p>
The child process itself can be killed or waited. In the latter case, the
function return code will be returned.
</p>

<p>
In this namespace there is also a <code>NamedPipe</code> class that provides Linux named
pipes. The constructor creates a <a href="https://linux.die.net/man/3/mkfifo">FIFO</a> with the given file name, and the
destructor removes it.
</p>

<p>
There is also an interesting <code>PosixSignalHandler</code> class, that handles POSIX
signals safely. You need to use it carefully though: initialize it at the
beginning of the main function, before any thread creation, and register all the
signal handlers as soon as possible, by using:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setSignalHandler</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signal</span>, <span style="color: #ce537a; font-weight: bold;">Handler</span> <span style="color: #7590db;">h</span>);
</pre>
</div>

<p>
where an handler is a callback that takes the signal that just happened:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #ce537a; font-weight: bold;">Handler</span> = <span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">function</span>&lt;<span style="color: #ce537a; font-weight: bold;">void</span>(<span style="color: #ce537a; font-weight: bold;">int</span>)&gt;;
</pre>
</div>

<p>
The POSIX standard says that a lot of functions are not safe to be used within
signal handlers. For example it's not possible to allocate heap memory and call
many standard library functions. We need however to support arbitrary code
execution in the handlers, so to workaround this we use a vector of atomic
booleans, one for each possible signal. Whenever a signal is sent to the
process, the handler flips the corresponding boolean to true. A separate thread
polls that vector, and executes the registered handlers, if any were given. This
allows the signal handler to return immediately and in a safe way:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">vector</span>&lt;<span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">atomic</span>&lt;<span style="color: #ce537a; font-weight: bold;">bool</span>&gt;&gt; <span style="color: #bc6ec5; font-weight: bold;">signalsToBeHandled</span>(SIGRTMAX);

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sigactionHandler</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sig</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span>* , <span style="color: #ce537a; font-weight: bold;">void</span>* )
{
  signalsToBeHandled[sig].store(<span style="color: #a45bad;">true</span>, <span style="color: #a45bad;">std</span>::memory_order_release);
}
</pre>
</div>

<p>
and the user-defined handler is called asynchronously in a separate thread. This
allows to execute arbitrary code.
</p>
</div>
</div>

<div id="outline-container-sec-3-7-6" class="outline-4">
<h4 id="sec-3-7-6"><span class="section-number-4">3.7.6</span> text</h4>
<div class="outline-text-4" id="text-3-7-6">
<p>
In this namespace we have some string manipulation utilities, like <code>toString</code>.
This free function converts any list of printable objects in an <code>std::string</code>,
e.g.
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #7590db;">s</span> = <span style="color: #a45bad;">text</span>::toString(<span style="color: #2d9574;">"my "</span>, <span style="color: #a45bad;">std</span>::<span style="color: #7590db;">string</span>(<span style="color: #2d9574;">"s"</span>), <span style="color: #a45bad;">15</span>, <span style="color: #a45bad;">true</span>);
</pre>
</div>

<p>
Allowing to both covert objects into strings and concatenate them, without the
need of odd <code>std::ostringstream</code> objects all around the codebase.
</p>

<p>
A <code>TextReplace</code> class allows to do replace variable occurrences in a text with
user specified values. For example:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">ifstream</span> <span style="color: #7590db;">f</span>(<span style="color: #2d9574;">"file.txt"</span>);
<span style="color: #a45bad;">std</span>::<span style="color: #ce537a; font-weight: bold;">ostringstream</span> <span style="color: #7590db;">out</span>;
<span style="color: #a45bad;">text</span>::<span style="color: #ce537a; font-weight: bold;">TextReplace</span> <span style="color: #7590db;">r</span>;
r.addVariable(<span style="color: #2d9574;">"var"</span>, <span style="color: #2d9574;">"X"</span>);
r.addVariable(<span style="color: #2d9574;">"foo"</span>, <span style="color: #2d9574;">"BAR"</span>);
r.replaceVariables(f, out);
</pre>
</div>

<p>
and suppose <code>file.txt</code> contains:
</p>

<pre class="example">
replace ${var} variables
with ${foo} their values ${p}.
</pre>

<p>
the result of the replacement will be:
</p>

<pre class="example">
replace X variables
with BAR their values ${p}.
</pre>

<p>
Note that unknown variables are left untouched.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Website</h2>
<div class="outline-text-2" id="text-4">
<p>
I am not so proud of the website code, and I don't recommend looking at it in
detail. I did not have much experience in web development at that time, but I am
still quite happy with the result. Year ago it was not so obvious that a website
was mobile ready:
</p>


<figure>
<p><img src="web-screenshots/home.png" class="img-responsive" alt="home.png">
</p>
</figure>


<figure>
<p><img src="web-screenshots/home-small.png" class="img-responsive" alt="home-small.png">
</p>
</figure>

<p>
The website is just a bunch HTML + JavaScript
pages. For the styling and the responsive design I went with the immortals
<a href="http://getbootstrap.com/">Bootstrap</a> and <a href="https://jquery.com/">JQuery</a>, while for the server side part I used the now infamous
PHP.
</p>

<p>
Commands like start and stop monitoring and live view are issued by the frontend
by doing <code>GET</code> requests to pages under the <code>controller/</code> path. The PHP backend
listening that endpoint sends POSIX signals to the main executable. The
communication is not more complicated than that, because this first
implementation worked fine. I didn't bother changing it in something more
complicated.
</p>

<p>
The funniest part of the frontend is the live view though. Also in this case the
first implementation was good enough :). Basically the frontend uses an infinite
loop of Ajax requests<sup><a id="fnr.3" name="fnr.3" class="footref" href="#fn.3">3</a></sup> to a special <code>live.jpg</code> picture, which is served by a
custom FastCGI backend, written in C++. This is the one described in the
<a href="#sec-5">FastCGI backend</a> section.
</p>

<div class="org-src-container">

<pre class="src src-javascript"><span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">loadImage</span>(<span style="color: #7590db;">url</span>, <span style="color: #7590db;">imageObj</span>, <span style="color: #7590db;">target</span>) {
    imageObj.onload = <span style="color: #4f97d7; font-weight: bold;">function</span>() {
        target.setAttribute(<span style="color: #2d9574;">'src'</span>, <span style="color: #a45bad;">this</span>.src);
        loadImage(url, imageObj, target);
    };
    imageObj.src = url + <span style="color: #2d9574;">'?_='</span> + <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">Date</span>().getTime();
}

$.ajax({ url: <span style="color: #2d9574;">'../controller/live.php'</span>,
         dataType: <span style="color: #2d9574;">'json'</span>,
         cache: <span style="color: #a45bad;">false</span>
       })
    .done(<span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">data</span>) {
        <span style="color: #4f97d7; font-weight: bold;">if</span> (data.result == <span style="color: #a45bad;">0</span>) {
            $(<span style="color: #2d9574;">'.live-container'</span>).html(
                <span style="color: #2d9574;">'&lt;img id="liveimg" class="img-responsive"&gt;&lt;/img&gt;'</span>
            );
            <span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">img</span> = document.getElementById(<span style="color: #2d9574;">'liveimg'</span>);
            loadImage(<span style="color: #2d9574;">'live.jpg'</span>, img, <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">Image</span>);
        }
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            displayMessage(<span style="color: #2d9574;">'.live-container'</span>,
                <span style="color: #2d9574;">'&lt;h4&gt;Ooops...&lt;/h4&gt;'</span> +
                <span style="color: #2d9574;">'&lt;p&gt;'</span> + data.log + <span style="color: #2d9574;">'&lt;/p&gt;'</span>,
                <span style="color: #2d9574;">'alert-danger'</span>);
    })
    .fail(<span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">jqxhr</span>, <span style="color: #7590db;">textStatus</span>, <span style="color: #7590db;">errorThrown</span>) {
        displayMessage(<span style="color: #2d9574;">'.live-container'</span>,
            <span style="color: #2d9574;">'&lt;h4&gt;Ooops...&lt;/h4&gt;'</span> +
            <span style="color: #2d9574;">'&lt;p&gt;'</span> + errorThrown + <span style="color: #2d9574;">'&lt;/p&gt;'</span>,
            <span style="color: #2d9574;">'alert-danger'</span>);
    });
</pre>
</div>

<p>
Yes, that's it. I didn't even have to shorten the code. Something that I
couldn't explain myself here was that in <code>loadImage</code> I couldn't use JQuery,
because it was much slower than the old style <code>setAttribute</code> and <code>image.src =
url</code>. So I decided to live with that.
</p>


<figure>
<p><img src="web-screenshots/live.png" class="img-responsive" alt="live.png">
</p>
</figure>

<p>
The archive page shows pictures from previous alarms. Just don't look at the PHP
code behind that, it's really horrible crap. It can give you nightmares for days.
</p>


<figure>
<p><img src="web-screenshots/archive.png" class="img-responsive" alt="archive.png">
</p>
</figure>

<p>
This is the carusel view:
</p>


<figure>
<p><img src="web-screenshots/archive-carusel.png" class="img-responsive" alt="archive-carusel.png">
</p>
</figure>

<p>
This is the mobile version:
</p>


<figure>
<p><img src="web-screenshots/archive-small.png" class="img-responsive" alt="archive-small.png">
</p>
</figure>

<p>
And this is the date selector for the alarm, in the mobile version:
</p>


<figure>
<p><img src="web-screenshots/archive-small-select.png" class="img-responsive" alt="archive-small-select.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> FastCGI backend</h2>
<div class="outline-text-2" id="text-5">
<p>
One of the website backend components is ironically in a folder called
<code>frontend</code>. The name is unfortunate but it was meant to suggest an interface to
the main executable. It communicates with it via a ZeroMQ socket, and with the
web server through <a href="https://en.wikipedia.org/wiki/FastCGI">FastCGI</a>.
</p>

<p>
Interestingly enough, the first implementation was in Python, but it was too
slow. I had to re-implement it in C++, and now it's about three orders of
magnitude faster (yes, I really mean 1000X).
</p>

<p>
The <code>main.cpp</code> file contains all the logic:
</p>
<ul class="org-ul">
<li>A webserver request is directed to the executable through the standard input
(which is ignored);
</li>
<li>a picture is requested to the main antifurto executable through a ZeroMQ
request;
</li>
<li>as soon as a reply arrives, it is immediately written to the standard output,
that is read by the webserver.
</li>
</ul>

<p>
There are a bunch of utility classes that have been used to make the code
cleaner, described in the following sections.
</p>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> ZmqLazyPirateClient</h3>
<div class="outline-text-3" id="text-5-1">
<p>
This class implements the <a href="http://zguide.zeromq.org/page:all#Client-Side-Reliability-Lazy-Pirate-Pattern">Lazy pirate pattern</a> in ZeroMQ, which is a
request-reply transition supporting socket reconnections. This allows to start
and stop the main executable and the webserver independently; the connection
between them will catch up automatically. When a request-reply transaction is
needed, this class will send the request and wait until the reply comes, or a
timeout expires. On timeout, the request is sent again, until the maximum number
of retrials is reached. At that point the transaction is considered failed.
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Stream utilities</h3>
<div class="outline-text-3" id="text-5-2">
<p>
The <code>StreamRedirector</code> class is responsible for redirecting the standard input
and output to FastCGI stream buffers, while <code>StreamReader</code> allows to buffer
reads from a stream (in this case the standard input). I actually don't remember
because it's a class instead of a simple function. Probably it's a non-sense.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Conclusion</h2>
<div class="outline-text-2" id="text-6">
<p>
In this post we had a look at the pet project I worked on for a while some years
ago. By skimming through this post again I realized that it is mostly a random
collection of impressions, design decisions and code snippets, so I don't know
how effective that is for a reader. However, for me it was important to wrap up,
because after all the time and effort spent, I didn't want to forget it, and I
also wanted to share my insights with the community.<sup><a id="fnr.4" name="fnr.4" class="footref" href="#fn.4">4</a></sup>
</p>

<p>
My takeaways are that with this project I learned some stuff and I did something
useful for myself. I would definitely recommend working on things you really
need, as opposed to experimenting with technologies purposelessly. It really
helps to get them done (to a certain extent at least). Or at least that's the
only way I found preventing me to give up projects too early.<sup><a id="fnr.5" name="fnr.5" class="footref" href="#fn.5">5</a></sup>
</p>

<p>
I hope this post gave you some interesting insights and maybe inspire you some
extensions, related projects or ideas. The code is open source on GitHub, under
<a href="https://github.com/mbrt/antifurto">mbrt/antifurto</a>, as I wrote earlier. I encourage you to take a look yourself to
some of the classes. You can also build it and use it as is for your own
security alarm. The deployment is kind of a pain right now, because there are
many dependencies and configuring the external services is not exactly easy to
do (Dropbox, mails, WhatsApp, etc). The documentation is also somehow lacking;
apologies for that.
</p>

<p>
That's all folks!
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
Take a look at the <a href="#sec-3-7-1">meta namespace</a> for the implementation.
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
If you are curious, the <code>ErasedUniquePtr</code> class is briefly described in
the <a href="#sec-3-7-1">meta namespace</a> section.
</p></div>

<div class="footdef"><sup><a id="fn.3" name="fn.3" class="footnum" href="#fnr.3">3</a></sup> <p class="footpara">
Yes, I know WebSocket existed already years ago, but really, at that time
my phone didn't support them, and I didn't feel like developing two different
protocols.
</p></div>

<div class="footdef"><sup><a id="fn.4" name="fn.4" class="footnum" href="#fnr.4">4</a></sup> <p class="footpara">
The license is GPL.
</p></div>

<div class="footdef"><sup><a id="fn.5" name="fn.5" class="footnum" href="#fnr.5">5</a></sup> <p class="footpara">
See <a href="http://250bpm.com/blog:50">do finish your stuff</a> by Martin Sstrik.
</p></div>


</div>
</div></div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Introduction</a>
<ul class="nav">
<li><a href="#sec-1-1">1.1. Why?</a></li>
<li><a href="#sec-1-2">1.2. What?</a></li>
<li><a href="#sec-1-3">1.3. Features</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Architecture</a></li>
<li><a href="#sec-3">3. Main executable</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. Main class</a></li>
<li><a href="#sec-3-2">3.2. Main controllers</a></li>
<li><a href="#sec-3-3">3.3. Picture's capture</a></li>
<li><a href="#sec-3-4">3.4. LiveView</a></li>
<li><a href="#sec-3-5">3.5. Picture recording</a></li>
<li><a href="#sec-3-6">3.6. Notifications</a></li>
<li><a href="#sec-3-7">3.7. Utility libraries</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Website</a></li>
<li><a href="#sec-5">5. FastCGI backend</a>
<ul class="nav">
<li><a href="#sec-5-1">5.1. ZmqLazyPirateClient</a></li>
<li><a href="#sec-5-2">5.2. Stream utilities</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Conclusion</a></li>
</ul>
</div>
</nav>
</div></div></div>
<footer id="postamble" class="">
<div><p class="date">Created: 2017-07-08 Sat 00:21</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.2.1 (<a href="http://orgmode.org">Org-mode</a> 9.0.5)</p>
</div>
</footer>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script src="../javascripts/analytics.js"></script>
</body>
</html>
